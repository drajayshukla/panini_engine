import streamlit as st
from core.phonology import sanskrit_varna_vichhed
from core.it_sanjna_engine import apply_halantyam
from core.analyzer import analyze_sanjna

# рдкреЗрдЬ рд╕реЗрдЯрдЕрдк
st.set_page_config(page_title="рдЕрд╖реНрдЯрд╛рдзреНрдпрд╛рдпреА-рдпрдВрддреНрд░", layout="wide", initial_sidebar_state="expanded")

# рдХрд╕реНрдЯрдо CSS (UI рдХреЛ рдереЛрдбрд╝рд╛ рдФрд░ рдЖрдХрд░реНрд╖рдХ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП)
st.markdown("""
    <style>
    .main {
        background-color: #f5f7f9;
    }
    .stCode {
        background-color: #ffffff !important;
    }
    </style>
    """, unsafe_allow_html=True)

st.title("ЁЯХЙя╕П рдЕрд╖реНрдЯрд╛рдзреНрдпрд╛рдпреА-рдпрдВрддреНрд░ (The Paninian Engine)")
st.caption("рдПрдХ рдУрдкрди-рд╕реЛрд░реНрд╕ рдкрд╛рдгрд┐рдиреАрдп рд╡реНрдпрд╛рдХрд░рдг рдЗрдВрдЬрди | Developed by Dr. Ajay Shukla")

# рд╕рд╛рдЗрдбрдмрд╛рд░ рдореЗрдВ рд╡рд┐рдЬрди рдФрд░ рдорд┐рд╢рди
with st.sidebar:
    st.header("ЁЯОп рд╡рд┐рдЬрди рдФрд░ рдорд┐рд╢рди")
    st.write("рдкрд╛рдгрд┐рдиреА рдХреЗ рекрежрежреж рд╕реВрддреНрд░реЛрдВ рдХреЛ рдПрд▓реНрдЧреЛрд░рд┐рдердорд┐рдХ рд▓реЙрдЬрд┐рдХ рдореЗрдВ рд╕рдВрд╣рд┐рддрд╛рдмрджреНрдз рдХрд░рдирд╛ред")
    st.markdown("---")
    st.info("рдпрд╣ рдЗрдВрдЬрди рд╡рд░реНрддрдорд╛рди рдореЗрдВ 'рдЗрддреН-рд╕рдВрдЬреНрдЮрд╛' рдФрд░ 'рд╕рдВрдЬреНрдЮрд╛ рдкреНрд░рдХрд░рдг' (1.1.1 - 1.1.2) рдкрд░ рдХрд╛рд░реНрдп рдХрд░ рд░рд╣рд╛ рд╣реИред")
    st.write("---")
    st.write("### ЁЯУЬ рд╡рд░реНрддрдорд╛рди рд╕реВрддреНрд░")
    st.write("1.1.1: рд╡реГрджреНрдзрд┐рд░рд╛рджреИрдЪреН")
    st.write("1.1.2: рдЕрджреЗрдЩреНрдЧреБрдгрдГ")
    st.write("1.3.3: рд╣рд▓рдиреНрддреНрдпрдореН")

# рдореБрдЦреНрдп рдЗрдВрдЯрд░рдлреЗрд╕
input_text = st.text_input("рд╕рдВрд╕реНрдХреГрдд рдЙрдкрджреЗрд╢ (рдзрд╛рддреБ/рдкреНрд░рддреНрдпрдп) рд▓рд┐рдЦреЗрдВ:", value="рд▓реНрдпреБрдЯреН")

if input_text:
    # 1. рд╡рд┐рдЪреНрдЫреЗрдж рдкреНрд░рдХреНрд░рд┐рдпрд╛
    varna_list = sanskrit_varna_vichhed(input_text)

    # рдореБрдЦреНрдп рдХреЙрд▓рдо
    col1, col2 = st.columns(2)

    with col1:
        st.subheader("рез. рд╡рд░реНрдг-рд╡рд┐рдЪреНрдЫреЗрдж (Phonology)")
        st.code(" + ".join(varna_list), language=None)
        st.caption("рдирд┐рдпрдо рез-резрем рдХреЗ рдЖрдзрд╛рд░ рдкрд░")

    # 2. рдЗрддреН-рд╕рдВрдЬреНрдЮрд╛ рдкреНрд░рдХреНрд░рд┐рдпрд╛
    remaining, its = apply_halantyam(varna_list.copy())

    with col2:
        st.subheader("реи. рдЗрддреН-рд╕рдВрдЬреНрдЮрд╛ (It-Sanjna)")
        if its:
            st.error(f"рд▓реЛрдк (рдЗрддреН рд╡рд░реНрдг): {' , '.join(its)}")
            st.markdown(f"**рд▓рд╛рдЧреВ рд╕реВрддреНрд░:** рез.рей.рей рд╣рд▓рдиреНрддреНрдпрдореН")
        else:
            st.warning("рдХреЛрдИ рдЗрддреН рд╡рд░реНрдг (рдЕрдВрддрд┐рдо рд╡реНрдпрдВрдЬрди) рдирд╣реАрдВ рдорд┐рд▓рд╛ред")

    st.markdown("---")

    # 3. рд╕рдВрдЬреНрдЮрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг (1.1.1 & 1.1.2)
    st.subheader("ЁЯФН рей. рд╕рдВрдЬреНрдЮрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг (Sanjna Analysis)")

    if varna_list:
        analysis = analyze_sanjna(varna_list)

        # рд╕рдВрдЬреНрдЮрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХреЛ рдХрд╛рд░реНрдб рдХреЗ рд░реВрдк рдореЗрдВ рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП
        cols = st.columns(len(varna_list) if len(varna_list) > 0 else 1)

        for idx, item in enumerate(analysis):
            with cols[idx]:
                v = item['varna']
                tags = item['tags']
                if tags:
                    st.success(f"**{v}**\n\n`{', '.join(tags)}`")
                else:
                    st.info(f"**{v}**\n\n-")

    st.markdown("---")
    st.subheader("ЁЯУК рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕рд╛рд░рд╛рдВрд╢ (Derivation Steps)")

    # рд╕реНрдЯреЗрдк-рдмрд╛рдп-рд╕реНрдЯреЗрдк рддрд╛рд▓рд┐рдХрд╛ (рдбреЗрдЯрд╛ рдлреНрд░реЗрдо рдХреА рддрд░рд╣)
    steps = [
        {"рдХреНрд░рдо": 1, "рдкреНрд░рдХреНрд░рд┐рдпрд╛": "рдореВрд▓ рд░реВрдк", "рд╕реНрдерд┐рддрд┐": input_text, "рд╕реВрддреНрд░": "-"},
        {"рдХреНрд░рдо": 2, "рдкреНрд░рдХреНрд░рд┐рдпрд╛": "рд╡рд░реНрдг-рд╡рд┐рдЪреНрдЫреЗрдж", "рд╕реНрдерд┐рддрд┐": " + ".join(varna_list), "рд╕реВрддреНрд░": "Phonology Rules"},
        {"рдХреНрд░рдо": 3, "рдкреНрд░рдХреНрд░рд┐рдпрд╛": "рд╣рд▓рдиреНрддреНрдпрдореН рд▓реЛрдк", "рд╕реНрдерд┐рддрд┐": " + ".join(remaining), "рд╕реВрддреНрд░": "рез.рей.рей рд╣рд▓рдиреНрддреНрдпрдореН"}
    ]
    st.table(steps)

    # рдкрд╛рдгрд┐рдиреАрдп рд╡рд┐рд╡рд░рдг
    with st.expander("рд╡реНрдпрд╛рдХрд░рдгрд┐рдХ рд╡рд┐рд╡рд░рдг (Grammar Details)"):
        st.write("""
        - **рд╡реГрджреНрдзрд┐рд░рд╛рджреИрдЪреН (рез.рез.рез)**: 'рдЖрдд' (рдЖ) рдФрд░ 'рдРрдЪреН' (рдР, рдФ) рдХреА рд╡реГрджреНрдзрд┐ рд╕рдВрдЬреНрдЮрд╛ рд╣реЛрддреА рд╣реИред
        - **рдЕрджреЗрдЩреНрдЧреБрдгрдГ (рез.рез.реи)**: 'рдЕрддреН' (рдЕ) рдФрд░ 'рдПрдЩреН' (рдП, рдУ) рдХреА рдЧреБрдг рд╕рдВрдЬреНрдЮрд╛ рд╣реЛрддреА рд╣реИред
        - **рд╣рд▓рдиреНрддреНрдпрдореН (рез.рей.рей)**: рдЙрдкрджреЗрд╢ рдХреЗ рдЕрдВрдд рдореЗрдВ рд╕реНрдерд┐рдд рд╡реНрдпрдВрдЬрди рдХреА рдЗрддреН рд╕рдВрдЬреНрдЮрд╛ рд╣реЛрддреА рд╣реИред
        """)