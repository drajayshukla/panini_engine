import streamlit as st
import json
import os
from core.pratyahara_engine import PratyaharaGenerator

# --- рез. рдкрд╛рдгрд┐рдиреАрдп рекреи рдкреНрд░рддреНрдпрд╛рд╣рд╛рд░реЛрдВ рдХреА рдкреНрд░рд╛рдорд╛рдгрд┐рдХ рд╕реВрдЪреА ---
PANINI_PRATYAHARAS = [
    "рдЕрдХреН", "рдЕрдЪреН", "рдЕрдЯреН", "рдЕрдгреН", "рдЕрдореН", "рдЕрд╢реН", "рдЕрд▓реН",
    "рдЗрдХреН", "рдЗрдЪреН", "рдЗрдгреН", "рдЙрдХреН", "рдПрдЩреН", "рдПрдЪреН", "рдРрдЪреН",
    "рдЦрдпреН", "рдЦрд░реН", "рдЩрдореН", "рдЪрдпреН", "рдЪрд░реН", "рдЫрд╡реН", "рдЬрд╢реН",
    "рдЭрдпреН", "рдЭрд░реН", "рдЭрд▓реН", "рдЭрд╢реН", "рдЭрд╖реН", "рддрдЩреН", "рддрд╡реН",
    "рдирдо", "рдордпреН", "рдпрдЮреН", "рдпрдгреН", "рдпрдореН", "рдпрдпреН", "рдпрд░реН",
    "рд╡рд▓реН", "рд╡рд╢реН", "рд╢рд▓реН", "рд╢рд░реН", "рд╣рд▓реН", "рд╣рд╢реН", "рд░"
]

# --- реи. рдкреЗрдЬ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди ---
st.set_page_config(page_title="Pratyahara Lab", layout="wide", page_icon="ЁЯО╝")
st.title("ЁЯО╝ рдкреНрд░рддреНрдпрд╛рд╣рд╛рд░ рдирд┐рд░реНрдорд╛рдг рдкреНрд░рдпреЛрдЧрд╢рд╛рд▓рд╛ (SK2 Lab)")
st.caption("рд╕реВрддреНрд░: рдЖрджрд┐рд░рдиреНрддреНрдпреЗрди рд╕рд╣реЗрддрд╛ (рез.рез.ренрез) - рдкреНрд░рддреНрдпрд╛рд╣рд╛рд░ рдЬрдирд░реЗрдЯрд░")


# --- рей. рдбреЗрдЯрд╛ рд▓реЛрдбрд░ ---
@st.cache_data
def load_shiva_sutras():
    path = 'data/shiva_sutras.json'
    if os.path.exists(path):
        with open(path, 'r', encoding='utf-8') as f:
            return json.load(f)['shiva_sutras']
    return []


shiva_sutras = load_shiva_sutras()

# рек. рдЖрджрд┐ рдФрд░ рдЕрдиреНрддреНрдп рд╡рд░реНрдгреЛрдВ рдХрд╛ рд╕рдВрдЧреНрд░рд╣
all_adis = []
all_its = []
for s in shiva_sutras:
    all_adis.extend(s['varnas'])
    all_its.append(s['it_varna'])

# --- рел. рдпреВрдЖрдИ рд▓реЗрдЖрдЙрдЯ ---
col1, col2 = st.columns([1, 2])

with col1:
    st.subheader("ЁЯЫая╕П рдирд┐рд░реНрдорд╛рдг рдкреИрд░рд╛рдореАрдЯрд░реНрд╕")
    mode = st.radio("рдореЛрдб рдЪреБрдиреЗрдВ:", ["Standard (рдкрд╛рдгрд┐рдиреАрдп)", "Custom (рдХреГрддреНрд░рд┐рдо)"])

    if mode == "Standard (рдкрд╛рдгрд┐рдиреАрдп)":
        selected_p = st.selectbox("рдЕрд╖реНрдЯрд╛рдзреНрдпрд╛рдпреА рдореЗрдВ рдкреНрд░рдпреБрдХреНрдд рдкреНрд░рддреНрдпрд╛рд╣рд╛рд░ рдЪреБрдиреЗрдВ:", options=sorted(PANINI_PRATYAHARAS))

        # 'Surgical' рд╡рд┐рдЪреНрдЫреЗрдж рд▓реЙрдЬрд┐рдХ: рдЖрджрд┐ рдФрд░ рдЕрдиреНрддреНрдп рдЗрддреН рдХреЛ рд╕рд╣реА рд╕реЗ рдЕрд▓рдЧ рдХрд░рдирд╛
        if selected_p == "рд░":
            adi_val, it_val = "рд░", "рд▓"
        else:
            # рдЖрджрд┐ рд╡рд░реНрдг рд╣рдореЗрд╢рд╛ рдкрд╣рд▓рд╛ рдЕрдХреНрд╖рд░ рд╣реЛрддрд╛ рд╣реИ
            adi_val = selected_p[0]
            # рдЕрдиреНрддреНрдп рдЗрддреН рдХреЗ рд▓рд┐рдП рдорд╛рд╣реЗрд╢реНрд╡рд░ рд╕реВрддреНрд░реЛрдВ рдореЗрдВ рдорд┐рд▓рд╛рди рдХрд░рдирд╛
            potential_it = selected_p[1:] + "реН"
            # рдпрджрд┐ 'рдЕрд╢реН' рдЪреБрдирд╛ рд╣реИ рддреЛ 'рд╢реН' рдЦреЛрдЬреЗрдВ
            it_val = next((it for it in all_its if it.startswith(selected_p[1:])), all_its[0])
    else:
        adi_val = st.selectbox("рдЖрджрд┐ рд╡рд░реНрдг (Start):", options=all_adis)
        it_val = st.selectbox("рдЕрдиреНрддреНрдп рдЗрддреН (End):", options=all_its)

# рем. рдкреНрд░рддреНрдпрд╛рд╣рд╛рд░ рдЬрдирд░реЗрд╢рди (Calling core logic)
result_varnas = PratyaharaGenerator.generate(adi_val, it_val, shiva_sutras)
clean_name = f"{adi_val}{it_val}".replace("реН", "")

# --- рен. рдореБрдЦреНрдп рдбрд┐рд╕реНрдкреНрд▓реЗ ---
with col2:
    st.header(f"ЁЯТа рд╡рд┐рд╢реНрд▓реЗрд╖рдг: {clean_name}")

    # рдкрд╛рдгрд┐рдиреАрдп рд╡реИрдзрддрд╛ рдЪреЗрдХ (Clinical Validation)
    is_panini = clean_name in PANINI_PRATYAHARAS or (clean_name == "рд░" and adi_val == "рд░")

    if is_panini:
        st.success(f"тЬЕ рдпрд╣ рдПрдХ **рдкреНрд░рд╛рдорд╛рдгрд┐рдХ рдкрд╛рдгрд┐рдиреАрдп рдкреНрд░рддреНрдпрд╛рд╣рд╛рд░** рд╣реИред")
    else:
        st.warning(f"тЪая╕П рдпрд╣ рдПрдХ **рдХреГрддреНрд░рд┐рдо (Artificial) рдкреНрд░рддреНрдпрд╛рд╣рд╛рд░** рд╣реИред")

    # рдкрд░рд┐рдгрд╛рдо рдХреА рдЬрд╛рдБрдЪ рдФрд░ рдкреНрд░рджрд░реНрд╢рди
    if not result_varnas:
        st.error(f"рддреНрд░реБрдЯрд┐: рдЖрджрд┐ рд╡рд░реНрдг '{adi_val}' рдФрд░ рдЕрдиреНрддреНрдп рдЗрддреН '{it_val}' рдХреЗ рдмреАрдЪ рдХреЛрдИ рд╡рд░реНрдг рдирд╣реАрдВ рдорд┐рд▓рд╛ред рдХреГрдкрдпрд╛ рдХреНрд░рдо рдЬрд╛рдБрдЪреЗрдВред")
    else:
        st.subheader("ЁЯУЪ рд╢рд╛рдорд┐рд▓ рд╡рд░реНрдг (Varnas):")
        varna_html = "".join([
                                 f"<div style='display:inline-block; background-color:#e1f5fe; border-radius:8px; padding:10px 20px; margin:5px; font-size:1.5rem; border:1px solid #01579b; font-weight:bold; color:#01579b;'>{v}</div>"
                                 for v in result_varnas])
        st.markdown(varna_html, unsafe_allow_html=True)
        st.info(f"рдХреБрд▓ рд╡рд░реНрдгреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛: **{len(result_varnas)}**")

# --- рео. рд╕рдВрджрд░реНрдн рддрд╛рд▓рд┐рдХрд╛ ---
st.divider()

with st.expander("ЁЯХЙя╕П рдорд╛рд╣реЗрд╢реНрд╡рд░ рд╕реВрддреНрд░ рд╕рдВрджрд░реНрдн рддрд╛рд▓рд┐рдХрд╛"):
    st.table([{"рдХреНрд░рдо": s['id'], "рд╕реВрддреНрд░": s['sutra'], "рд╡рд░реНрдг": ", ".join(s['varnas']), "рдЗрддреН": s['it_varna']} for s in
              shiva_sutras])