import streamlit as st
import json
import os
import pandas as pd

# --- рез. рдкреЗрдЬ рд╕реЗрдЯрдЕрдк ---
st.set_page_config(page_title="Vibhakti Rules Engine", layout="wide", page_icon="тЪЦя╕П")


@st.cache_data
def load_shabd_data():
    file_path = os.path.join("data", "shabdroop.json")
    try:
        if not os.path.exists(file_path): return []
        with open(file_path, "r", encoding="utf-8") as file:
            return json.load(file)
    except:
        return []


# --- реи. рдирд┐рдпрдо рдбреЗрдЯрд╛рдмреЗрд╕ (The Diagnostic Rules) ---
# рдпрд╣рд╛рдБ рд╣рдо рдкреНрд░рддреНрдпрдп рдХреЗ рдЕрдВрдд рдФрд░ рдЙрдирд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╡рд┐рднрдХреНрддрд┐рдпреЛрдВ рдХреЛ рдореИрдк рдХрд░ рд░рд╣реЗ рд╣реИрдВ
RULES = {
    "рдГ (Visarga)": ["рдкреНрд░рдердорд╛ рдПрдХрд╡рдЪрди", "рдкреНрд░рдердорд╛ рдмрд╣реБрд╡рдЪрди", "рд╖рд╖реНрдареА рдПрдХрд╡рдЪрди", "рдкрдЮреНрдЪрдореА рдПрдХрд╡рдЪрди"],
    "рдореН (Halanta M)": ["рджреНрд╡рд┐рддреАрдпрд╛ рдПрдХрд╡рдЪрди"],
    "рдирд╛ / рдПрдг (Instrumental Pattern)": ["рддреГрддреАрдпрд╛ рдПрдХрд╡рдЪрди"],
    "рднреНрдпрд╛рдореН (Dual Case)": ["рддреГрддреАрдпрд╛ рджреНрд╡рд┐рд╡рдЪрди", "рдЪрддреБрд░реНрдереА рджреНрд╡рд┐рд╡рдЪрди", "рдкрдЮреНрдЪрдореА рджреНрд╡рд┐рд╡рдЪрди"],
    "рдП / рдЖрдп (Dative Pattern)": ["рдЪрддреБрд░реНрдереА рдПрдХрд╡рдЪрди", "рд╕рдкреНрддрдореА рдПрдХрд╡рдЪрди"],
    "рдЕрд╕реНрдп (Genitive Pattern)": ["рд╖рд╖реНрдареА рдПрдХрд╡рдЪрди"],
    "рд╖реБ / рд╕реБ (Locative Plural)": ["рд╕рдкреНрддрдореА рдмрд╣реБрд╡рдЪрди"],
    "рдУрдГ (Dual Gen/Loc)": ["рд╖рд╖реНрдареА рджреНрд╡рд┐рд╡рдЪрди", "рд╕рдкреНрддрдореА рджреНрд╡рд┐рд╡рдЪрди"],
    "рдЖрдореН (Genitive Plural)": ["рд╖рд╖реНрдареА рдмрд╣реБрд╡рдЪрди"],
    "рднрд┐рдГ (Instrumental Plural)": ["рддреГрддреАрдпрд╛ рдмрд╣реБрд╡рдЪрди"]
}


def main():
    st.title("тЪЦя╕П рд╡рд┐рднрдХреНрддрд┐ рдкрд╣рдЪрд╛рди (Rules-based Diagnosis)")
    st.info("рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рд▓рдХреНрд╖рдгреЛрдВ рдХреЛ рдЯрд┐рдХ рдХрд░реЗрдВред рд╕рд┐рд╕реНрдЯрдо рдЙрдирдХреЗ рдЖрдзрд╛рд░ рдкрд░ рд╕рдВрднрд╛рд╡рд┐рдд рд╡рд┐рднрдХреНрддрд┐ рдмрддрд╛рдПрдЧрд╛ред")

    data = load_shabd_data()

    # --- рей. рд╕рд┐рд▓реЗрдХреНрд╢рди рдЗрдВрдЯрд░рдлреЗрд╕ (The Tick Options) ---
    st.sidebar.header("ЁЯФН рдкреНрд░рддреНрдпрдп рд▓рдХреНрд╖рдг рдЪреБрдиреЗрдВ (Rules)")
    selected_rules = []
    for rule in RULES.keys():
        if st.sidebar.checkbox(rule):
            selected_rules.append(rule)

    # --- рек. рд▓реЙрдЬрд┐рдХ рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ ---
    possible_diagnoses = set()
    for rule in selected_rules:
        for vibhakti in RULES[rule]:
            possible_diagnoses.add(vibhakti)

    # --- рел. рдкрд░рд┐рдгрд╛рдо рдкреНрд░рджрд░реНрд╢рди ---
    col1, col2 = st.columns([1, 1])

    with col1:
        st.subheader("ЁЯОп рд╕рдВрднрд╛рд╡рд┐рдд рд╡рд┐рднрдХреНрддрд┐/рд╡рдЪрди")
        if not selected_rules:
            st.warning("рдХреГрдкрдпрд╛ рдмрд╛рдИрдВ рдУрд░ рд╕реЗ рдХреЛрдИ рд▓рдХреНрд╖рдг рдЪреБрдиреЗрдВред")
        else:
            for d in sorted(list(possible_diagnoses)):
                st.success(f"тЬЕ {d}")

    with col2:
        st.subheader("ЁЯУЦ рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдЙрджрд╛рд╣рд░рдг")
        if selected_rules and data:
            # рд╣рдо рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдЦреЛрдЬреЗрдВрдЧреЗ рдХрд┐ рдХреМрди рд╕реЗ рд╢рдмреНрдж рдЗрди рдирд┐рдпрдореЛрдВ рдХрд╛ рдкрд╛рд▓рди рдХрд░рддреЗ рд╣реИрдВ
            examples = []
            for entry in data[:100]:  # рдкрд╣рд▓реЗ резрежреж рд╢рдмреНрджреЛрдВ рдореЗрдВ рд╕рд░реНрдЪ
                forms = [f.strip() for f in entry["forms"].split(";")]
                for rule in selected_rules:
                    # рдирд┐рдпрдо рдХреЗ рдЕрдВрдд (Suffix) рдХреЛ рдХреНрд▓реАрди рдХрд░рдирд╛
                    suffix = rule.split(" ")[0]
                    for f in forms:
                        if f.endswith(suffix):
                            examples.append({
                                "рд╢рдмреНрдж": entry["word"],
                                "рд▓рд┐рдВрдЧ": entry["linga"],
                                "рдорд┐рд▓рддрд╛-рдЬреБрд▓рддрд╛ рд░реВрдк": f,
                                "рдЕрд░реНрде": entry["artha_hin"]
                            })

            if examples:
                df = pd.DataFrame(examples).drop_duplicates().head(10)
                st.table(df)
            else:
                st.write("рдХреЛрдИ рдЙрджрд╛рд╣рд░рдг рдирд╣реАрдВ рдорд┐рд▓рд╛ред")

    # --- рем. рд╡рд┐рдЬрд╝реБрдЕрд▓рд╛рдЗрдЬрд╝реЗрд╢рди ---
    st.divider()
    st.subheader("ЁЯФм рд╡реНрдпрд╛рдХрд░рдгрд┐рдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ (Prakriya)")
    st.write("рд╕реБрдкреН-рдкреНрд░рддреНрдпрдп (Su-au-jas...) рдЬрдм рдкреНрд░рд╛рддрд┐рдкрджрд┐рдХ рдХреЗ рд╕рд╛рде рдЬреБреЬрддреЗ рд╣реИрдВ, рддреЛ рд╡реЗ рдХреБрдЫ рд╡рд┐рд╢рд┐рд╖реНрдЯ 'Signatures' рдЫреЛреЬрддреЗ рд╣реИрдВред")


if __name__ == "__main__":
    main()