import streamlit as st
import json
import os
import random
import pandas as pd
from collections import Counter

# --- рез. рдкреЗрдЬ рд╕реЗрдЯрдЕрдк ---
st.set_page_config(page_title="Vibhakti Diagnostic Engine", layout="wide", page_icon="ЁЯФм")

@st.cache_data
def load_shabd_data():
    file_path = os.path.join("data", "shabdroop.json")
    try:
        if not os.path.exists(file_path): return []
        with open(file_path, "r", encoding="utf-8") as file:
            return json.load(file)
    except:
        return []

# --- реи. Sanskrit-Aware Suffix Matcher ---
def sanskrit_match(word, suffix):
    if not suffix or suffix == "--рд╕рднреА рджрд┐рдЦрд╛рдПрдВ--": return True
    word = str(word).strip()

    vowel_to_matra = {
        'рдЖ': 'рд╛', 'рдЗ': 'рд┐', 'рдИ': 'реА', 'рдЙ': 'реБ', 'рдК': 'реВ',
        'рдЛ': 'реГ', 'реа': 'реД', 'рдП': 'реЗ', 'рдР': 'реИ', 'рдУ': 'реЛ', 'рдФ': 'реМ'
    }

    if suffix.startswith('рдЕ'):
        core = suffix[1:]
        if not word.endswith(core): return False
        pos = len(word) - len(core) - 1
        if pos < 0: return False
        return '\u0915' <= word[pos] <= '\u0939'

    for v, m in vowel_to_matra.items():
        if suffix.startswith(v):
            if word.endswith(m + suffix[1:]): return True

    return word.endswith(suffix)

# --- рей. рдорд╛рд╕реНрдЯрд░ рд▓реЙрдЬрд┐рдХ рдПрд╡рдВ рдХреНрд░рдо (Robust Rules) ---
LOGIC_RULES = {
    "рдкреНрд░рдердорд╛ рдПрдХрд╡рдЪрди": ["рдГ", "рдиреН", "рдореН", "рд╛", "реА", "реВ", "рдЛ", "рдХреН", "рдЯреН", "рдкреН", "рддреН", "рд╛рдГ", "рд╡", "рд╛", "рд╣"],
    "рдкреНрд░рдердорд╛ рджреНрд╡рд┐рд╡рдЪрди": ["рдФ", "реМ", "рдП", "реЗ", "рдИ", "реА", "рдиреА", "рдгреА"],
    "рдкреНрд░рдердорд╛ рдмрд╣реБрд╡рдЪрди": ["рд╛рдГ", "рдпрдГ", "рд╡рдГ", "рдгрд┐", "рд╕рд┐", "рдЕрдГ", "рд╣рдГ", "рдзрдГ", "рд╢рдГ", "рддрдГ", "рдирдГ", "рдп", "рдП", "рд╛"],
    "рджреНрд╡рд┐рддреАрдпрд╛ рдмрд╣реБрд╡рдЪрди": ["рдЖрдиреН", "рдИрдиреН", "реВрдиреН", "реДрдиреН", "рдГ", "рдИрдГ", "рдКрдГ", "рдЕрдГ", "рд╛рдГ", "рд╛рдирд┐", "рд╛рдгрд┐"],
    "рддреГрддреАрдпрд╛ рдПрдХрд╡рдЪрди": ["рдПрдг", "рдгрд╛", "рдирд╛", "рдпрд╛", "рддреНрд░рд╛", "рд╕рд╛", "рд╡рд╛", "рд╛", "рддрд╛", "рдзрд╛", "рднрд╛", "рдпрд╛", "рдирд╛", "рдЗрдирд╛"],
    "рдЪрддреБрд░реНрдереА рдПрдХрд╡рдЪрди": ["рдЖрдп", "рдпреЗ", "рд╡реЗ", "рддреНрд░реЗ", "рдпреИ", "рд╕реНрдореИ", "рднреНрдпрдореН", "рддреЗ", "рдиреЗ", "рд╕реЗ", "рдП", "рдиреЗ", "рдпреЗ", "рдП"],
    "рд╖рд╖реНрдареА рдПрдХрд╡рдЪрди": ["рд╕реНрдп", "рдЕрдГ", "рдУрдГ", "рдЖрдГ", "рдпрд╛рдГ", "рддреБрдГ", "рд╕рдГ", "рддрдГ", "рдирдГ", "рдЪрдГ", "рдЬрдГ", "рд╖рдГ", "рд╣рдГ", "рд╢рдГ"],
    "рд╕рдкреНрддрдореА рдПрдХрд╡рдЪрди": ["рдП", "рдФ", "рд░рд┐", "рддрд┐", "рдирд┐", "рд╡рд┐", "рдпрд┐", "рдпрд╛рдореН", "рд╡рд╛рдореН", "рдЗ", "рд╖рд┐", "рдзрд┐", "рд╕реНрдорд┐рдиреН", "рдЖрдореН", "реМ"]
}

# рдпрд╣реА рд╡рд╣ рдбрд┐рдХреНрд╢рдирд░реА рд╣реИ рдЬрд┐рд╕рдХреА рдХрдореА рд╕реЗ Error рдЖ рд░рд╣реА рдереА
VIBHAKTI_ORDER = {
    "рдкреНрд░рдердорд╛ рдПрдХрд╡рдЪрди": 1,
    "рдкреНрд░рдердорд╛ рджреНрд╡рд┐рд╡рдЪрди": 2,
    "рдкреНрд░рдердорд╛ рдмрд╣реБрд╡рдЪрди": 3,
    "рджреНрд╡рд┐рддреАрдпрд╛ рдмрд╣реБрд╡рдЪрди": 6,
    "рддреГрддреАрдпрд╛ рдПрдХрд╡рдЪрди": 7,
    "рдЪрддреБрд░реНрдереА рдПрдХрд╡рдЪрди": 10,
    "рд╖рд╖реНрдареА рдПрдХрд╡рдЪрди": 16,
    "рд╕рдкреНрддрдореА рдПрдХрд╡рдЪрди": 19
}

def main():
    st.title("ЁЯФм Clinical Vibhakti Diagnostic Engine")
    st.caption("рд╡рд┐рднрдХреНрддрд┐ рдХреНрд░рдорд╛рдиреБрд╕рд╛рд░ рд╕рдВрддреБрд▓рд┐рдд рдкреНрд░рджрд░реНрд╢рди (Max 50 results total)")

    data = load_shabd_data()
    if not data:
        st.error("рдбреЗрдЯрд╛рдмреЗрд╕ (data/shabdroop.json) рдЕрдкреНрд░рд╛рдкреНрдд рд╣реИред")
        st.stop()

    all_symptoms = sorted(list(set([s for rules in LOGIC_RULES.values() for s in rules])))
    selected_symptom = st.sidebar.selectbox("рдкреНрд░рддреНрдпрдп рд▓рдХреНрд╖рдг рдЪреБрдиреЗрдВ:", ["--рд╕рднреА рджрд┐рдЦрд╛рдПрдВ--"] + all_symptoms)

    # --- рек. рд╕рдВрддреБрд▓рд┐рдд рдбрд╛рдпрдЧреНрдиреЛрд╕реНрдЯрд┐рдХ рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ ---
    matches = []
    category_counter = Counter()
    random.shuffle(data)

    limit_per_category = 7 # рдкреНрд░рддрд┐ рд╢реНрд░реЗрдгреА рд▓рдЧрднрдЧ рен рддрд╛рдХрд┐ релреж рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХреЗрдВ

    for entry in data:
        if len(matches) >= 50: break

        raw_forms = entry.get("forms", "").split(";")
        if len(raw_forms) < 21: continue

        mapping = {
            "рдкреНрд░рдердорд╛ рдПрдХрд╡рдЪрди": raw_forms[0], "рдкреНрд░рдердорд╛ рджреНрд╡рд┐рд╡рдЪрди": raw_forms[1], "рдкреНрд░рдердорд╛ рдмрд╣реБрд╡рдЪрди": raw_forms[2],
            "рджреНрд╡рд┐рддреАрдпрд╛ рдмрд╣реБрд╡рдЪрди": raw_forms[5], "рддреГрддреАрдпрд╛ рдПрдХрд╡рдЪрди": raw_forms[6], "рдЪрддреБрд░реНрдереА рдПрдХрд╡рдЪрди": raw_forms[9],
            "рд╖рд╖реНрдареА рдПрдХрд╡рдЪрди": raw_forms[15], "рд╕рдкреНрддрдореА рдПрдХрд╡рдЪрди": raw_forms[18]
        }

        for vibhakti, roop in mapping.items():
            if category_counter[vibhakti] >= limit_per_category: continue

            for p in LOGIC_RULES[vibhakti]:
                if sanskrit_match(roop, p):
                    if selected_symptom == "--рд╕рднреА рджрд┐рдЦрд╛рдПрдВ--" or sanskrit_match(roop, selected_symptom):
                        matches.append({
                            "order": VIBHAKTI_ORDER[vibhakti],
                            "рд╢рдмреНрдж": entry.get("word"),
                            "рд╡рд┐рднрдХреНрддрд┐": vibhakti,
                            "рд░реВрдк": roop,
                            "рд▓рдХреНрд╖рдг": p
                        })
                        category_counter[vibhakti] += 1
                        break
            if len(matches) >= 50: break

    # --- рел. рд╕реЙрд░реНрдЯрд┐рдВрдЧ рдПрд╡рдВ рдкреНрд░рджрд░реНрд╢рди ---
    if matches:
        sorted_examples = sorted(matches, key=lambda x: x['order'])
        df = pd.DataFrame(sorted_examples)
        st.table(df[["рд╢рдмреНрдж", "рд╡рд┐рднрдХреНрддрд┐", "рд░реВрдк", "рд▓рдХреНрд╖рдг"]])
        st.info(f"ЁЯТб рд╕рдВрддреБрд▓рд┐рдд рдкреНрд░рджрд░реНрд╢рди: рдХреБрд▓ {len(matches)} рдЙрджрд╛рд╣рд░рдг рдХреНрд░рдорд╛рдиреБрд╕рд╛рд░ (1.1 тЖТ 7.1) рдкреНрд░рджрд░реНрд╢рд┐рдд рд╣реИрдВред")
    else:
        st.warning(f"рд▓рдХреНрд╖рдг '{selected_symptom}' рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдореЗрд▓ рдирд╣реАрдВ рдорд┐рд▓рд╛ред")

    st.divider()
    st.subheader("ЁЯзм рдкрдж-рдирд┐рд░реНрдорд╛рдг рдкреНрд░рдХреНрд░рд┐рдпрд╛ (Morphology)")
    #

if __name__ == "__main__":
    main()