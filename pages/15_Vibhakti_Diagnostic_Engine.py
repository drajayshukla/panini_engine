import streamlit as st
import json
import os
import random
import pandas as pd

# --- рез. рдкреЗрдЬ рд╕реЗрдЯрдЕрдк ---
st.set_page_config(page_title="Vibhakti Diagnostic Engine", layout="wide", page_icon="ЁЯФм")


@st.cache_data
def load_shabd_data():
    file_path = os.path.join("data","shabdroop.json")
    try:
        if not os.path.exists(file_path): return []
        with open(file_path, "r", encoding="utf-8") as file:
            return json.load(file)
    except:
        return []


# --- реи. рдбреЙрдХреНрдЯрд░ рд╕рд╛рд╣рдм рдХрд╛ 'Master Logic' (Data Integrated) ---
LOGIC_RULES = {
    "рдкреНрд░рдердорд╛ рдПрдХрд╡рдЪрди": {"symptoms": ["рдГ (рд╡рд┐рд╕рд░реНрдЧ)", "рдиреН (рд╣рд▓рдиреНрдд)", "рдореН (рд╣рд▓рдиреНрдд)", "рд╕реНрд╡рд░ рдЕрдВрдд"]},
    "рдкреНрд░рдердорд╛ рджреНрд╡рд┐рд╡рдЪрди": {"symptoms": ["рдЖ", "рдИ", "рдФ", "рдП"]},
    "рдкреНрд░рдердорд╛ рдмрд╣реБрд╡рдЪрди": {"symptoms": ["рд╛рдГ (рджреАрд░реНрдШ рд╡рд┐рд╕рд░реНрдЧ)", "рдпрдГ / рд╡рдГ", "рдгрд┐ / рд╕рд┐"]},
    "рджреНрд╡рд┐рддреАрдпрд╛ рдмрд╣реБрд╡рдЪрди": {"symptoms": ["рдЖрдиреН", "рдИрдиреН", "реВрдиреН", "реДрдиреН", "рдГ"]},
    "рддреГрддреАрдпрд╛ рдПрдХрд╡рдЪрди": {"symptoms": ["рдПрдг", "рдгрд╛", "рдирд╛", "рдпрд╛", "рддреНрд░рд╛", "рд╕рд╛"]},
    "рдЪрддреБрд░реНрдереА рдПрдХрд╡рдЪрди": {"symptoms": ["рд╛рдп", "рдпреЗ", "рд╡реЗ", "рддреНрд░реЗ", "рдпреИ", "рд╕реНрдореИ", "рднреНрдпрдореН"]},
    "рд╖рд╖реНрдареА рдПрдХрд╡рдЪрди": {"symptoms": ["рд╕реНрдп", "рдГ (рд╡рд┐рд╕рд░реНрдЧ)", "рдУрдГ", "рдЖрдГ", "рдпрд╛рдГ", "рддреБрдГ"]},
    "рд╕рдкреНрддрдореА рдПрдХрд╡рдЪрди": {"symptoms": ["рдП", "рдФ", "рд░рд┐", "рддрд┐", "рдирд┐", "рдпрд┐", "рдпрд╛рдореН"]}
}


def main():
    st.title("ЁЯФм Clinical Vibhakti Diagnostic Engine")
    st.caption("рд╢рдмреНрджреНрд░реВрдк рдбреЗрдЯрд╛рдмреЗрд╕ рдПрд╡рдВ рдбреЙрдХреНрдЯрд░ рдЕрдЬрдп рд╢реБрдХреНрд▓рд╛ рдХреЗ 'Suffix Logic' рдХрд╛ рдПрдХреАрдХрд░рдг")

    data = load_shabd_data()
    if not data:
        st.error("shabdroop.json рд▓реЛрдб рдирд╣реАрдВ рд╣реЛ рд╕рдХрд╛ред")
        st.stop()

    # --- рей. рдбрд╛рдпрдЧреНрдиреЛрд╕реНрдЯрд┐рдХ рдлрд┐рд▓реНрдЯрд░ ---
    st.sidebar.header("ЁЯФН рд▓рдХреНрд╖рдг (Symptoms)")
    all_symptoms = []
    for v in LOGIC_RULES.values():
        all_symptoms.extend(v["symptoms"])

    selected_symptom = st.sidebar.selectbox("рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкреНрд░рддреНрдпрдп рд▓рдХреНрд╖рдг рдЪреБрдиреЗрдВ:",
                                            ["--рдЪреБрдиреЗрдВ--"] + sorted(list(set(all_symptoms))))

    # --- рек. реиреж рд░реИрдВрдбрдо рдореИрдЪрд┐рдВрдЧ рдЙрджрд╛рд╣рд░рдг (The Core Logic) ---
    st.subheader("ЁЯОп рд░реИрдВрдбрдо 'Pattern Match' рдЙрджрд╛рд╣рд░рдг (Top 20)")

    matches = []
    # рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЛ рд╕реНрдХреИрди рдХрд░рдирд╛
    for entry in data:
        word = entry.get("word", "")
        forms = [f.strip() for f in entry.get("forms", "").split(";")]
        if len(forms) < 21: continue

        # рдЖрдкрдХреЗ рд▓реЙрдЬрд┐рдХ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдореИрдкрд┐рдВрдЧ
        mapping = {
            "рдкреНрд░рдердорд╛ рдПрдХрд╡рдЪрди": forms[0],
            "рдкреНрд░рдердорд╛ рджреНрд╡рд┐рд╡рдЪрди": forms[1],
            "рдкреНрд░рдердорд╛ рдмрд╣реБрд╡рдЪрди": forms[2],
            "рджреНрд╡рд┐рддреАрдпрд╛ рдмрд╣реБрд╡рдЪрди": forms[5],
            "рддреГрддреАрдпрд╛ рдПрдХрд╡рдЪрди": forms[6],
            "рдЪрддреБрд░реНрдереА рдПрдХрд╡рдЪрди": forms[9],
            "рд╖рд╖реНрдареА рдПрдХрд╡рдЪрди": forms[15],
            "рд╕рдкреНрддрдореА рдПрдХрд╡рдЪрди": forms[18]
        }

        for vibhakti, roop in mapping.items():
            # рдпрджрд┐ рдХреЛрдИ рд▓рдХреНрд╖рдг рдЪреБрдирд╛ рдЧрдпрд╛ рд╣реИ рдпрд╛ рд╣рдо рдЬрдирд░рд▓ рд▓рд┐рд╕реНрдЯ рджрд┐рдЦрд╛ рд░рд╣реЗ рд╣реИрдВ
            if selected_symptom != "--рдЪреБрдиреЗрдВ--":
                clean_symptom = selected_symptom.split(" ")[0]
                if roop.endswith(clean_symptom):
                    matches.append({"рд╢рдмреНрдж": word, "рд╡рд┐рднрдХреНрддрд┐": vibhakti, "рд░реВрдк": roop, "рдЕрд░реНрде": entry.get("artha_hin")})
            else:
                # рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд░реИрдВрдбрдо рд╕реИрдВрдкрд▓ рдХреЗ рд▓рд┐рдП рдбреЗрдЯрд╛ рдЗрдХрдЯреНрдард╛ рдХрд░рдирд╛
                matches.append({"рд╢рдмреНрдж": word, "рд╡рд┐рднрдХреНрддрд┐": vibhakti, "рд░реВрдк": roop, "рдЕрд░реНрде": entry.get("artha_hin")})

    if matches:
        # реиреж рд░реИрдВрдбрдо рдЙрджрд╛рд╣рд░рдг рдЪреБрдирдирд╛
        random_matches = random.sample(matches, min(20, len(matches)))
        df = pd.DataFrame(random_matches)
        st.table(df)
    else:
        st.warning("рдЗрд╕ рд▓рдХреНрд╖рдг рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдореЗрд▓ рдирд╣реАрдВ рдорд┐рд▓рд╛ред")

    # --- рел. рд╡рд┐рдЬрд╝реБрдЕрд▓рд╛рдЗрдЬрд╝реЗрд╢рди ---
    st.divider()
    st.subheader("ЁЯзм рд╡рд┐рднрдХреНрддрд┐-рдкреНрд░рддреНрдпрдп рд╕рдВрдпреЛрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛")

    st.info(
        "рдпрд╣ рддрд╛рд▓рд┐рдХрд╛ рджрд┐рдЦрд╛рддреА рд╣реИ рдХрд┐ рдХреИрд╕реЗ рдкреНрд░рд╛рддрд┐рдкрджрд┐рдХ рдХреЗ рдЕрдВрдд рдФрд░ рд╕реБрдкреН-рдкреНрд░рддреНрдпрдп рдХреЗ рдорд┐рд▓рди рд╕реЗ 'Clinical Signature' (рд░реВрдк) рддреИрдпрд╛рд░ рд╣реЛрддрд╛ рд╣реИред")


if __name__ == "__main__":
    main()