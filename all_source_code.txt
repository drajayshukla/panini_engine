================================================================================
FILE: master_runner.py
================================================================================

"""
FILE: master_runner.py
PAS-v6.0 (Siddha) | PILLAR: R17 Laká¹£ya-Laká¹£aá¹‡a (Validation)
PURPOSE: Automatically discovers and runs ALL tests in the 'tests/' directory.
         Now also shows which test files were actually found and executed.
"""

import unittest
import sys
import os
import time
from pathlib import Path


def run_all_tests():
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1. Setup Environment
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    project_root = Path(__file__).resolve().parent
    if str(project_root) not in sys.path:
        sys.path.insert(0, str(project_root))

    tests_dir = project_root / "tests"

    print("=" * 70)
    print("ğŸš€ PÄ€á¹†INIAN ENGINE MASTER TEST SUITE")
    print(f"ğŸ“‚ Scanning: {tests_dir}")
    print("=" * 70)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2. Discover Tests
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    loader = unittest.TestLoader()

    try:
        suite = loader.discover(
            start_dir=str(tests_dir),
            pattern="test_*.py",
            top_level_dir=str(project_root),
        )
    except Exception as e:
        print(f"âŒ Error during test discovery: {e}")
        return

    if suite.countTestCases() == 0:
        print("âš ï¸  No tests found!")
        print("    â†’ Make sure files start with 'test_'")
        print("    â†’ and contain classes that inherit from unittest.TestCase")
        sys.exit(1)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3. Collect & Show which files were actually discovered
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    discovered_files = set()

    def collect_test_files(suite_or_case):
        if isinstance(suite_or_case, unittest.TestSuite):
            for item in suite_or_case:
                collect_test_files(item)
        elif isinstance(suite_or_case, unittest.TestCase):
            file_path = suite_or_case.__class__.__module__.replace(".", os.sep) + ".py"
            full_path = (tests_dir / file_path).resolve()
            discovered_files.add(str(full_path.relative_to(project_root)))

    collect_test_files(suite)

    print("\nğŸ“‹ Discovered and will run test files:")
    for f in sorted(discovered_files):
        print(f"  â€¢ {f}")
    print(f"   (total: {len(discovered_files)} files)\n")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4. Run Tests
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    runner = unittest.TextTestRunner(verbosity=2, buffer=True)
    start_time = time.time()

    result = runner.run(suite)

    end_time = time.time()
    duration = end_time - start_time

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5. Final Report
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n" + "â•" * 70)
    print(f"â±  Time taken:     {duration:.3f} s")
    print(f"   Tests run:      {result.testsRun}")
    print(f"   âœ… Passed:       {result.testsRun - len(result.failures) - len(result.errors)}")
    print(f"   âŒ Failures:     {len(result.failures)}")
    print(f"   âš   Errors:       {len(result.errors)}")
    print("â•" * 70)

    if result.wasSuccessful():
        print("ğŸ‰ SIDDHAM! All systems operational.")
        sys.exit(0)
    else:
        print("ğŸ”¥ REGRESSION DETECTED â€” please fix failing tests.")
        sys.exit(1)


if __name__ == "__main__":
    run_all_tests()


================================================================================
FILE: app.py
================================================================================

import streamlit as st

# --- Page Config ---
st.set_page_config(
    page_title="PÄá¹‡inian Engine",
    page_icon="ğŸ•‰ï¸",
    layout="wide"
)

# --- Styling ---
st.markdown("""
<style>
    .big-title { font-size: 3rem; font-weight: 800; color: #8e44ad; text-align: center; }
    .subtitle { font-size: 1.2rem; text-align: center; color: #555; }
    .feature-card { background-color: #f0f2f6; padding: 20px; border-radius: 10px; border-left: 5px solid #8e44ad; margin-bottom: 20px; }
</style>
""", unsafe_allow_html=True)


def main():
    st.markdown('<p class="big-title">ğŸ•‰ï¸ The PÄá¹‡inian Engine</p>', unsafe_allow_html=True)
    st.markdown('<p class="subtitle">A "Glassbox" Computational Approach to Sanskrit Grammar</p>',
                unsafe_allow_html=True)

    st.divider()

    c1, c2 = st.columns([2, 1])

    with c1:
        st.header("ğŸ¯ Mission")
        st.write("""
        This project is a precision-engineered implementation of **PÄá¹‡ini's Aá¹£á¹­ÄdhyÄyÄ«**. 
        Unlike "Blackbox" AI models that guess patterns, this engine strictly follows the 
        4,000 algorithmic rules encoded 2,500 years ago.

        It currently masters the **Subanta (Nominal Declension)** process for *RÄma-shabda* (Masculine a-stem), achieving **100% SIDDHA status** across all 8 Vibhaktis.
        """)

        st.info("ğŸ‘ˆ Select **'Declension Engine'** from the sidebar to use the tool.")

    with c2:
        st.image("https://upload.wikimedia.org/wikipedia/commons/thumb/8/80/Panini_statue.jpg/440px-Panini_statue.jpg",
                 caption="Maharshi PÄá¹‡ini")

    st.divider()

    st.header("ğŸ›ï¸ The 20 Strategic Pillars")
    st.write("The engine architecture is grounded in these immutable principles:")

    with st.expander("View the 20 Pillars of Logic"):
        st.markdown("""
        1. **UpadeÅ›a**: Raw data initialization.
        2. **Vará¹‡aviccheda**: Atomic tokenization.
        3. **Saá¹ƒjÃ±Ä**: Class tagging (OOP logic).
        4. **Anubandha**: Metadata flags (IT markers).
        5. **Anuvá¹›tti**: Recursive state persistence.
        6. **SthÄnyÄdeÅ›a**: Substitution mapping.
        7. **ParibhÄá¹£Ä**: Spatial/Context logic.
        8. **BalÄ«yaá¸¥**: Conflict resolution hierarchy.
        9. **Asiddhatvam**: The TripÄdÄ« "invisibility" wall.
        10. **SÅ«tra-bheda**: Taxonomy of rules.
        11. **Niyama**: Constraint validation.
        12. **AdhikÄra**: Governing headers.
        13. **SthÄnivadbhÄva**: Inheritance of properties.
        14. **Antaraá¹…ga-Bahiraá¹…ga**: Proximity priority.
        15. **JÃ±Äpaka**: Inference from redundancy.
        16. **YogavibhÄga**: Rule splitting.
        17. **Laká¹£ya-Laká¹£aá¹‡a**: Empirical validation (TDD).
        18. **KÄrakÄnvaya**: Semantic dependency mapping.
        19. **Vivaká¹£Ä**: User intent (Speaker's desire).
        20. **Arthabheda**: Semantic middleware.
        """)


if __name__ == "__main__":
    main()


================================================================================
FILE: engine_main.py
================================================================================

"""
FILE: engine_main.py
PURPOSE: Core Logger utility with Varna-Viccheda capability.
"""

class PrakriyaLogger:
    def __init__(self):
        self.history = []

    def log(self, rule, operation, result, raw_state=None):
        """
        Logs a derivation step with atomic character breakdown.
        """
        viccheda = ""
        if raw_state:
            # List of Varna objects -> "à¤°à¥ + à¤† + à¤®à¥ + à¤…"
            chars = [v.char for v in raw_state]
            viccheda = " + ".join(chars)

        step_data = {
            "rule": rule,
            "operation": operation,
            "result": str(result),
            "viccheda": viccheda 
        }
        self.history.append(step_data)

    def print_history(self):
        """Console printing logic."""
        print("\n=== Prakriya Derivation (à¤ªà¥à¤°à¤•à¥à¤°à¤¿à¤¯à¤¾) ===")
        for step in self.history:
            print(f"â†’ {step['result']}   [{step['operation']}: {step['rule']}]")
            if step['viccheda']:
                print(f"   â†³ ğŸ” à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£: {step['viccheda']}")
        print("=======================================")

    def get_history(self):
        return self.history



================================================================================
FILE: fix_sandhi.py
================================================================================

"""
FILE: fix_sandhi.py
PURPOSE: Force-update the Sandhi logic and clear cache to solve the 'Ramau' bug.
"""
import os
import shutil
import subprocess
import sys

# 1. Define the Correct Code (No 'joined' variable)
NEW_SANDHI_CODE = '''"""
FILE: logic/sandhi_processor.py
PAS-v6.0 (Siddha) | PILLAR: Sandhi & Tripadi
"""
print("âœ… SANDHI PROCESSOR v3.0 (LIVE) LOADED") 

from core.core_foundation import Varna, sanskrit_varna_samyoga, PratyaharaEngine

pe = PratyaharaEngine()

class SandhiProcessor:

    @staticmethod
    def apply_ac_sandhi(anga, suffix):
        """
        Orchestrator for 6.1.x Vowel Sandhis.
        Returns: (modified_varnas, rule_code)
        """
        if not anga or not suffix: return anga + suffix, None

        last = anga[-1]
        first = suffix[0]

        # ----------------------------------------------------------------------
        # 1. VRIDDHIRECI (6.1.88) vs PRATHAMAYOH PURVASAVARNAH (6.1.102)
        # ----------------------------------------------------------------------
        if last.char in ['à¤…', 'à¤†']:
            if first.is_vowel:

                # Check Exception: 6.1.104 Nadici
                is_ic = pe.is_in(first.char, "à¤‡à¤šà¥")

                if is_ic:
                    # 6.1.104 blocks 6.1.102.
                    # Fallback to 6.1.88 Vriddhireci (a + ec -> Vriddhi)
                    if pe.is_in(first.char, "à¤à¤š"): # e, o, ai, au
                        # Rama + Au -> Ramau
                        last.char = 'à¤”' # Update Anga (In-Place)
                        last.trace.append("6.1.88")
                        suffix.pop(0)   # Remove Suffix Vowel (In-Place)

                        # [CRITICAL FIX]: Return fresh combination
                        return anga + suffix, "6.1.88"

                else:
                    # 6.1.102 applies (e.g., Rama + As)
                    if first.char == 'à¤…':
                        last.char = 'à¤†'
                        last.trace.append("6.1.102")
                        suffix.pop(0)
                        return anga + suffix, "6.1.102"

        # ----------------------------------------------------------------------
        # 2. AKA SAVARNE DIRGHA (6.1.101)
        # ----------------------------------------------------------------------
        savarna_pairs = {
            'à¤…': ['à¤…','à¤†'], 'à¤†': ['à¤…','à¤†'],
            'à¤‡': ['à¤‡','à¤ˆ'], 'à¤ˆ': ['à¤‡','à¤ˆ'],
            'à¤‰': ['à¤‰','à¤Š'], 'à¤Š': ['à¤‰','à¤Š']
        }

        if last.char in savarna_pairs and first.char in savarna_pairs[last.char]:
            long_map = {'à¤…':'à¤†', 'à¤†':'à¤†', 'à¤‡':'à¤ˆ', 'à¤ˆ':'à¤ˆ', 'à¤‰':'à¤Š', 'à¤Š':'à¤Š'}
            last.char = long_map[last.char]
            last.trace.append("6.1.101")
            suffix.pop(0)
            return anga + suffix, "6.1.101"

        return anga + suffix, None

    # ==========================================================================
    # TRIPADI (8.2 - 8.4)
    # ==========================================================================
    @staticmethod
    def run_tripadi(varna_list):
        """Ramah: s -> ru -> r -> h"""
        if not varna_list: return []

        # 8.2.66 Sasajusho Ruh
        if varna_list[-1].char in ['à¤¸à¥', 'à¤·à¥']:
            varna_list[-1].char = 'à¤°à¥'
            varna_list[-1].trace.append("8.2.66")

        # 8.3.15 Kharavasanayor Visarjaniyah
        if varna_list[-1].char == 'à¤°à¥':
             varna_list[-1].char = 'à¤ƒ'
             varna_list[-1].trace.append("8.3.15")

        return varna_list
'''

# 2. Overwrite the File
target_path = os.path.join("logic", "sandhi_processor.py")
with open(target_path, "w", encoding="utf-8") as f:
    f.write(NEW_SANDHI_CODE)
print(f"âœ… FORCED UPDATE: {target_path} written successfully.")

# 3. Nuke __pycache__
for root, dirs, files in os.walk("."):
    for d in dirs:
        if d == "__pycache__":
            shutil.rmtree(os.path.join(root, d))
print("âœ… CACHE CLEARED: All __pycache__ folders deleted.")

# 4. Run the Master Test
print("\nğŸš€ RUNNING MASTER TEST...")
subprocess.run([sys.executable, "tests/master_test.py"])


================================================================================
FILE: core/knowledge_base.py
================================================================================

"""
FILE: core/knowledge_base.py
"""
class KnowledgeBase:
    SUP_MAP = {
        1: [("à¤¸à¥à¤", set()), ("à¤”", set()), ("à¤œà¤¸à¥", set())],
        2: [("à¤…à¤®à¥", set()), ("à¤”à¤Ÿà¥", set()), ("à¤¶à¤¸à¥", set())],
        3: [("à¤Ÿà¤¾", set()), ("à¤­à¥à¤¯à¤¾à¤®à¥", set()), ("à¤­à¤¿à¤¸à¥", set())],
        4: [("à¤™à¥‡", set()), ("à¤­à¥à¤¯à¤¾à¤®à¥", set()), ("à¤­à¥à¤¯à¤¸à¥", set())],
        5: [("à¤™à¤¸à¤¿à¤", set()), ("à¤­à¥à¤¯à¤¾à¤®à¥", set()), ("à¤­à¥à¤¯à¤¸à¥", set())],
        6: [("à¤™à¤¸à¥", set()), ("à¤“à¤¸à¥", set()), ("à¤†à¤®à¥", set())],
        7: [("à¤™à¤¿", set()), ("à¤“à¤¸à¥", set()), ("à¤¸à¥à¤ªà¥", set())],
        8: [("à¤¸à¥à¤", set()), ("à¤”", set()), ("à¤œà¤¸à¥", set())] # Sambodhana (Reuse Prathama)
    }
    @staticmethod
    def get_sup(vibhakti, vacana):
        if vibhakti in KnowledgeBase.SUP_MAP:
            row = KnowledgeBase.SUP_MAP[vibhakti]
            if 1 <= vacana <= 3: return row[vacana-1]
        return None
    @staticmethod
    def is_sarvanama(word):
        sarva_list = ["à¤¸à¤°à¥à¤µ", "à¤µà¤¿à¤¶à¥à¤µ", "à¤‰à¤­", "à¤‰à¤­à¤¯", "à¤¡à¤¤à¤°", "à¤¡à¤¤à¤®", "à¤…à¤¨à¥à¤¯", "à¤…à¤¨à¥à¤¯à¤¤à¤°", "à¤‡à¤¤à¤°", "à¤¤à¥à¤µà¤¤à¥", "à¤¤à¥à¤µ", "à¤¨à¥‡à¤®", "à¤¸à¤®", "à¤¸à¤¿à¤®", "à¤ªà¥‚à¤°à¥à¤µ", "à¤ªà¤°", "à¤…à¤µà¤°", "à¤¦à¤•à¥à¤·à¤¿à¤£", "à¤‰à¤¤à¥à¤¤à¤°", "à¤…à¤ªà¤°", "à¤…à¤§à¤°", "à¤¸à¥à¤µ", "à¤…à¤¨à¥à¤¤à¤°", "à¤¤à¥à¤¯à¤¦à¥", "à¤¤à¤¦à¥", "à¤¯à¤¦à¥", "à¤à¤¤à¤¦à¥", "à¤‡à¤¦à¤®à¥", "à¤…à¤¦à¤¸à¥", "à¤à¤•", "à¤¦à¥à¤µà¤¿", "à¤¯à¥à¤·à¥à¤®à¤¦à¥", "à¤…à¤¸à¥à¤®à¤¦à¥", "à¤­à¤µà¤¤à¥", "à¤•à¤¿à¤®à¥"]
        return word in sarva_list



================================================================================
FILE: core/__init__.py
================================================================================

# panini_engine/core/__init__.py
from .core_foundation import ad, Varna, UpadeshaType, pe
from .sanjna_controller import SanjnaController


================================================================================
FILE: core/sanjna_controller.py
================================================================================

"""
FILE: core/sanjna_controller.py
PAS-v6.0 (Siddha) | PILLAR: Definitions & Cleaning (R3, R4)
"""
from .core_foundation import Varna, PratyaharaEngine, UpadeshaType

pe = PratyaharaEngine()

class SanjnaController:
    TAG_FACTORY = {
        'à¤à¤¿': 'Ã±it', 'à¤Ÿà¥': 'á¹­it', 'à¤¡à¥': 'dit',
        'à¤•à¥': 'kit', 'à¤™à¥': 'ngit', 'à¤šà¥': 'cit', 'à¤à¥': 'Ã±it',
        'à¤£à¥': 'á¹‡it', 'à¤ªà¥': 'pit', 'à¤®à¥': 'mit', 'à¤¶à¥': 'Å›it', 'à¤·à¥': 'á¹£it'
    }
    LASHAKVA = ['à¤²à¥', 'à¤¶à¥', 'à¤•à¥', 'à¤–à¥', 'à¤—à¥', 'à¤˜à¥', 'à¤™à¥']
    CHU_VARGA = ['à¤šà¥', 'à¤›à¥', 'à¤œà¥', 'à¤à¥', 'à¤à¥']
    TU_VARGA  = ['à¤Ÿà¥', 'à¤ à¥', 'à¤¡à¥', 'à¤¢à¥', 'à¤£à¥']

    @staticmethod
    def run_it_prakaran(varna_list, source_type, is_taddhita=False):
        if not varna_list: return [], []
        it_indices = set()
        trace = []

        # 1.3.2 Upadeshe Aj Anunasika
        for i, v in enumerate(varna_list):
            if v.char == 'à¤':
                it_indices.add(i)
                if i > 0 and varna_list[i - 1].is_vowel:
                    varna_list[i - 1].sanjnas.add("it")
                    it_indices.add(i - 1)
                    trace.append("1.3.2")

        first = varna_list[0].char
        if source_type == UpadeshaType.DHATU:
            if first in ['à¤à¤¿', 'à¤Ÿà¥', 'à¤¡à¥'] or (len(varna_list) > 1 and first == 'à¤à¥' and varna_list[1].char == 'à¤‡'):
                it_indices.add(0)
                if first == 'à¤à¥': it_indices.add(1)
                trace.append("1.3.5")

        # [CRITICAL FIX]: Vibhakti is also checked here
        elif source_type in [UpadeshaType.PRATYAYA, UpadeshaType.VIBHAKTI]:
            if first in SanjnaController.CHU_VARGA or first in SanjnaController.TU_VARGA:
                it_indices.add(0)
                trace.append("1.3.7 (Chuá¹­Å«)")
            elif not is_taddhita and first in SanjnaController.LASHAKVA:
                it_indices.add(0)
                trace.append("1.3.8 (Lashakva)")

        # 1.3.3 Halantyam
        last_idx = len(varna_list) - 1
        if last_idx >= 0 and last_idx not in it_indices:
            last_char = varna_list[last_idx].char
            is_vibhakti_blocked = (source_type == UpadeshaType.VIBHAKTI and last_char in ['à¤¤à¥', 'à¤¥à¥', 'à¤¦à¥', 'à¤§à¥', 'à¤¨à¥', 'à¤¸à¥', 'à¤®à¥'])
            if varna_list[last_idx].is_consonant and not is_vibhakti_blocked:
                it_indices.add(last_idx)
                trace.append("1.3.3")

        inherited_tags = set()
        for idx in it_indices:
            char_clean = varna_list[idx].char.replace('à¥', '')
            if char_clean in SanjnaController.TAG_FACTORY:
                inherited_tags.add(SanjnaController.TAG_FACTORY[char_clean])

        cleaned = [v for i, v in enumerate(varna_list) if i not in it_indices]
        if cleaned and inherited_tags:
            cleaned[0].sanjnas.update(inherited_tags)
        return cleaned, trace

    @staticmethod
    def is_vriddhi_1_1_1(char): return char == 'à¤†' or pe.is_in(char, "à¤à¤šà¥")
    @staticmethod
    def is_guna_1_1_2(char): return char == 'à¤…' or pe.is_in(char, "à¤à¤™à¥")
    @staticmethod
    def is_samyoga_1_1_7(varna_list):
        if len(varna_list) < 2: return False
        for i in range(len(varna_list) - 1):
            if varna_list[i].is_consonant and varna_list[i + 1].is_consonant: return True
        return False
    @staticmethod
    def is_laghu_1_4_10(varna_list, index):
        if index >= len(varna_list): return False
        v = varna_list[index]
        if not v.is_vowel: return False
        is_short = v.char in ['à¤…', 'à¤‡', 'à¤‰', 'à¤‹', 'à¤Œ']
        if not is_short: return False
        if index < len(varna_list) - 2:
            if varna_list[index + 1].is_consonant and varna_list[index + 2].is_consonant: return False
        return True
    @staticmethod
    def is_nadi_1_4_3(stem_varnas):
        if not stem_varnas: return False
        return stem_varnas[-1].char in ['à¤ˆ', 'à¤Š']
    @staticmethod
    def is_ghi_1_4_7(stem_varnas):
        if not stem_varnas: return False
        return stem_varnas[-1].char in ['à¤‡', 'à¤‰']


================================================================================
FILE: core/core_foundation.py
================================================================================

"""
FILE: core/core_foundation.py
PAS-v6.0 (Siddha) | PILLAR: The Physics (R1, R2, R17)
"""
import re

VOWELS_MAP = {'à¤¾': 'à¤†', 'à¤¿': 'à¤‡', 'à¥€': 'à¤ˆ', 'à¥': 'à¤‰', 'à¥‚': 'à¤Š', 'à¥ƒ': 'à¤‹', 'à¥„': 'à¥ ', 'à¥¢': 'à¤Œ', 'à¥£': 'à¥¡', 'à¥‡': 'à¤', 'à¥ˆ': 'à¤', 'à¥‹': 'à¤“', 'à¥Œ': 'à¤”'}
REVERSE_VOWELS_MAP = {v: k for k, v in VOWELS_MAP.items()}
INDEPENDENT_VOWELS = 'à¤…à¤†à¤‡à¤ˆà¤‰à¤Šà¤‹à¥ à¤Œà¥¡à¤à¤à¤“à¤”'
STHANA_MAP = {"à¤•à¤£à¥à¤ ": "à¤…à¤†à¤•à¤–à¤—à¤˜à¤™à¤¹à¤ƒ", "à¤¤à¤¾à¤²à¥": "à¤‡à¤ˆà¤šà¤›à¤œà¤à¤à¤¯à¤¶", "à¤®à¥‚à¤°à¥à¤§à¤¾": "à¤‹à¥ à¤Ÿà¤ à¤¡à¤¢à¤£à¤°à¤·", "à¤¦à¤¨à¥à¤¤": "à¤Œà¤¤à¤¥à¤¦à¤§à¤¨à¤²à¤¸", "à¤“à¤·à¥à¤ ": "à¤‰à¤Šà¤ªà¤«à¤¬à¤­à¤®", "à¤¨à¤¾à¤¸à¤¿à¤•à¤¾": "à¤™à¤à¤£à¤¨à¤®à¤‚à¤", "à¤•à¤£à¥à¤ à¤¤à¤¾à¤²à¥": "à¤à¤", "à¤•à¤£à¥à¤ à¥‹à¤·à¥à¤ ": "à¤“à¤”", "à¤¦à¤¨à¥à¤¤à¥‹à¤·à¥à¤ ": "à¤µ"}

class Varna:
    def __init__(self, raw_unit):
        self.char = raw_unit

        # Identity Checks
        self.is_vowel = any(v in raw_unit for v in INDEPENDENT_VOWELS) or 'à¥©' in raw_unit
        self.is_anunasika = 'à¤' in raw_unit
        self.is_consonant = not self.is_vowel and 'à¥' in raw_unit

        # [CRITICAL FIX]: These attributes are required by SanjnaController
        self.sanjnas = set()  # Tag storage
        self.trace = []       # History storage
        self.sthana = []      # Physics storage

        self._set_shiksha_profile()

    def _set_shiksha_profile(self):
        base = self.char[0]
        for place, chars in STHANA_MAP.items():
            if base in chars: self.sthana.append(place)
        if self.is_anunasika and "à¤¨à¤¾à¤¸à¤¿à¤•à¤¾" not in self.sthana: self.sthana.append("à¤¨à¤¾à¤¸à¤¿à¤•à¤¾")
    def __repr__(self): return self.char

def sanskrit_varna_vichhed(text, return_objects=True):
    """
    R2: Varnaviccheda - Robust Tokenization
    Handles complex cases like 'Su~' (à¤¸à¥à¤) -> [s, u, ~]
    """
    if not text: return []
    if text == "à¥": res = ["à¤…", "à¤‰", "à¤®à¥"]
    else:
        text = text.replace('à¤•à¥à¤·', 'à¤•à¥â€Œà¤·').replace('à¤¤à¥à¤°', 'à¤¤à¥â€Œà¤°').replace('à¤œà¥à¤', 'à¤œà¥â€Œà¤').replace('à¤¶à¥à¤°', 'à¤¶à¥â€Œà¤°').replace('à¤½', 'à¤…')
        text = re.sub(r'à¤‚(?=[à¤•à¤–à¤—à¤˜])', 'à¤™à¥', text); text = re.sub(r'à¤‚(?=[à¤šà¤›à¤œà¤])', 'à¤à¥', text)
        text = re.sub(r'à¤‚(?=[à¤Ÿà¤ à¤¡à¤¢])', 'à¤£à¥', text); text = re.sub(r'à¤‚(?=[à¤¤à¤¥à¤¦à¤§])', 'à¤¨à¥', text)
        text = re.sub(r'à¤‚(?=[à¤ªà¤«à¤¬à¤­])', 'à¤®à¥', text)

        res = []
        i = 0
        while i < len(text):
            char = text[i]

            # CASE A: Independent Vowels (e.g., 'A')
            if char in INDEPENDENT_VOWELS:
                unit = char
                if i+1 < len(text) and text[i+1] == 'à¥©': unit += 'à¥©'; i+=1
                res.append(unit)
                # Consume modifiers (Anusvara/Visarga/Chandra)
                while i+1 < len(text) and text[i+1] in 'à¤‚à¤ƒà¤':
                    if text[i+1] == 'à¤‚' and (i+2==len(text) or text[i+2]==' '): res.append('à¤®à¥')
                    else: res.append(text[i+1])
                    i+=1

            # CASE B: Consonants (e.g., 'K')
            elif '\u0915' <= char <= '\u0939' or char == 'à¤³':
                res.append(char + 'à¥')
                found_vowel = False

                if i+1 < len(text):
                    nxt = text[i+1]

                    # 1. Virama (Half-letter)
                    if nxt == 'à¥':
                        i+=1; found_vowel = True

                    # 2. Matra (Vowel Sign) e.g., 'u' in 'Su'
                    elif nxt in VOWELS_MAP:
                        res.append(VOWELS_MAP[nxt])
                        i+=1; found_vowel = True

                        # [CRITICAL]: Look for modifiers AFTER the Matra (e.g., 'Su~')
                        while i+1 < len(text) and text[i+1] in 'à¤‚à¤ƒà¤':
                            if text[i+1] == 'à¤‚' and (i+2==len(text) or text[i+2]==' '): res.append('à¤®à¥')
                            else: res.append(text[i+1])
                            i+=1

                    # 3. Implicit 'A' triggers
                    elif nxt in 'à¤‚à¤ƒà¤':
                        res.append('à¤…'); found_vowel = True
                        if nxt == 'à¤‚' and (i+2==len(text) or text[i+2]==' '): res.append('à¤®à¥')
                        else: res.append(nxt)
                        i+=1

                    # 4. Space
                    elif nxt == ' ':
                        res.append('à¤…'); found_vowel = True

                if not found_vowel: res.append('à¤…')

            # CASE C: Vedic Accents
            elif char in 'á³²á³³': res.append(char)
            i+=1

    return [Varna(s) for s in res] if return_objects else res

def sanskrit_varna_samyoga(varna_list):
    if not varna_list: return ""
    text_list = [v.char for v in varna_list]
    res = ""
    for char in text_list:
        if not res: res = char; continue
        if res.endswith('à¥') and any(v in char for v in INDEPENDENT_VOWELS):
            matra = REVERSE_VOWELS_MAP.get(char[0], "") if char[0] != 'à¤…' else ""
            res = res[:-1] + matra
            if len(char) > 1: res += char[1:]
        else: res += char
    return res

ad = sanskrit_varna_vichhed

class PratyaharaEngine:
    def __init__(self):
        self.sutras = [
            {"varnas": ["à¤…", "à¤‡", "à¤‰"], "it": "à¤£à¥"}, {"varnas": ["à¤‹", "à¤Œ"], "it": "à¤•à¥"},
            {"varnas": ["à¤", "à¤“"], "it": "à¤™à¥"}, {"varnas": ["à¤", "à¤”"], "it": "à¤šà¥"},
            {"varnas": ["à¤¹", "à¤¯", "à¤µ", "à¤°"], "it": "à¤Ÿà¥"}, {"varnas": ["à¤²"], "it": "à¤£à¥"},
            {"varnas": ["à¤", "à¤®", "à¤™", "à¤£", "à¤¨"], "it": "à¤®à¥"}, {"varnas": ["à¤", "à¤­"], "it": "à¤à¥"},
            {"varnas": ["à¤˜", "à¤¢", "à¤§"], "it": "à¤·à¥"}, {"varnas": ["à¤œ", "à¤¬", "à¤—", "à¤¡", "à¤¦"], "it": "à¤¶à¥"},
            {"varnas": ["à¤–", "à¤«", "à¤›", "à¤ ", "à¤¥", "à¤š", "à¤Ÿ", "à¤¤"], "it": "à¤µà¥"},
            {"varnas": ["à¤•", "à¤ª"], "it": "à¤¯à¥"}, {"varnas": ["à¤¶", "à¤·", "à¤¸"], "it": "à¤°à¥"},
            {"varnas": ["à¤¹"], "it": "à¤²à¥"}
        ]
        self._cache = {}

    def get_varnas(self, name):
        if name in self._cache: return self._cache[name]

        # Robust IT extraction
        if not name: return []
        adi = name[0]
        it_marker = name[1:]
        if it_marker and not it_marker.endswith('à¥'): it_marker += 'à¥'

        res = []
        collecting = False
        for sutra in self.sutras:
            s_varnas = sutra['varnas']
            s_it = sutra['it']
            if not s_it.endswith('à¥'): s_it += 'à¥'
            if not collecting and adi in s_varnas:
                idx = s_varnas.index(adi)
                res.extend(s_varnas[idx:])
                collecting = True
                if s_it == it_marker: self._cache[name] = res; return res
                continue
            if collecting:
                res.extend(s_varnas)
                if s_it == it_marker: self._cache[name] = res; return res
        return []

    def is_in(self, char, p_name):
        simple_char = char[0]
        savarna_map = {'à¤†':'à¤…', 'à¤ˆ':'à¤‡', 'à¤Š':'à¤‰', 'à¥ ':'à¤‹'}
        lookup = savarna_map.get(simple_char, simple_char)
        pset = self.get_varnas(p_name)
        return lookup in pset

class UpadeshaType:
    DHATU="dhatu"; PRATYAYA="pratyaya"; VIBHAKTI="vibhakti"; AGAMA="agama"; ADESHA="adesha"; PRATIPADIKA="pratipadika"
    @staticmethod
    def auto_detect(text): return UpadeshaType.PRATIPADIKA, None, "Default"

pe = PratyaharaEngine()


================================================================================
FILE: tests/test_saptami.py
================================================================================

"""
FILE: tests/test_saptami.py
"""
import unittest
from engine_main import PrakriyaLogger
from logic.subanta_processor import SubantaProcessor

class TestRamaSaptami(unittest.TestCase):
    def setUp(self): self.logger = PrakriyaLogger()

    def test_7_1_rame(self):
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 7, 1, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤°à¤¾à¤®à¥‡")

    def test_7_2_ramayoh(self):
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 7, 2, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤°à¤¾à¤®à¤¯à¥‹à¤ƒ")

    def test_7_3_ramesu(self):
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 7, 3, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤°à¤¾à¤®à¥‡à¤·à¥")

if __name__ == '__main__': unittest.main()



================================================================================
FILE: tests/test_panchami.py
================================================================================

"""
FILE: tests/test_panchami.py
TEST CASE: Rama (Panchami Vibhakti - Ablative)
"""
import unittest
from engine_main import PrakriyaLogger
from logic.subanta_processor import SubantaProcessor

class TestRamaPanchami(unittest.TestCase):
    
    def setUp(self):
        self.logger = PrakriyaLogger()

    def test_5_1_ramat(self):
        """Test 5.1: RÄma + Ngasi -> RÄmÄt"""
        print("\n" + "="*60)
        print("ğŸš€ TEST 5.1: RÄma + Ngasi (Panchami Ekavachana)")
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 5, 1, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤°à¤¾à¤®à¤¾à¤¤à¥")

    def test_5_2_ramabhyam(self):
        """Test 5.2: RÄma + BhyÄm -> RÄmÄbhyÄm"""
        print("\n" + "="*60)
        print("ğŸš€ TEST 5.2: RÄma + BhyÄm (Panchami Dvivachana)")
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 5, 2, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤°à¤¾à¤®à¤¾à¤­à¥à¤¯à¤¾à¤®à¥")

    def test_5_3_ramebhyah(self):
        """Test 5.3: RÄma + Bhyas -> RÄmebhyaá¸¥"""
        print("\n" + "="*60)
        print("ğŸš€ TEST 5.3: RÄma + Bhyas (Panchami Bahuvachana)")
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 5, 3, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤°à¤¾à¤®à¥‡à¤­à¥à¤¯à¤ƒ")

if __name__ == '__main__':
    unittest.main()



================================================================================
FILE: tests/master_test.py
================================================================================

"""
FILE: tests/test_prathama.py
TEST CASE: Rama (Ramah, Ramau, Ramah)
"""
import sys
import os

# Ensure imports work from the tests directory
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from engine_main import PrakriyaLogger
from logic.subanta_processor import SubantaProcessor

# ==============================================================================
# TEST 1: Prathama Ekavachana (1.1) -> RÄmaá¸¥ (à¤°à¤¾à¤®à¤ƒ)
# ==============================================================================
def test_1_1_ramah():
    print("\n" + "="*60)
    print("ğŸš€ TEST 1.1: RÄma + Su (Prathama Ekavachana)")
    print("="*60)

    word = "à¤°à¤¾à¤®"
    vibhakti = 1
    vacana = 1
    logger = PrakriyaLogger()

    # Execution
    final_form = SubantaProcessor.derive_pada(word, vibhakti, vacana, logger)
    history = logger.steps

    # Output Verification
    print(f"Input: {word}")
    print(f"â†’ {word} + à¤¸à¥à¤ [ à¤ªà¥à¤°à¤¥à¤®à¥ˆà¤•à¤µà¤šà¤¨à¤µà¤¿à¤µà¤•à¥à¤·à¤¾à¤¯à¤¾à¤‚ à¤¸à¥à¤µà¥Œà¤œà¤¸à¤®à¥Œà¤Ÿà¥... à¥ª.à¥§.à¥¨ à¤‡à¤¤à¤¿ à¤¸à¥à¤-à¤ªà¥à¤°à¤¤à¥à¤¯à¤¯à¤ƒ à¥¤ ]")
    print(f"â†’ {word} + à¤¸à¥ [ à¤‰à¤ªà¤¦à¥‡à¤¶à¥‡à¤½à¤œà¤¨à¥à¤¨à¤¾à¤¸à¤¿à¤• à¤‡à¤¤à¥ à¥§.à¥©.à¥¨ à¤‡à¤¤à¤¿ à¤‡à¤¤à¥à¤¸à¤‚à¤œà¥à¤à¤¾ à¥¤ à¤¤à¤¸à¥à¤¯ à¤²à¥‹à¤ªà¤ƒ à¥§.à¥©.à¥¯ à¥¤ ]")
    print(f"â†’ à¤°à¤¾à¤®à¤°à¥à¤  [ à¤ªà¤¦à¤¾à¤¨à¥à¤¤-à¤¸à¤•à¤¾à¤°à¤¸à¥à¤¯ à¤¸à¤¸à¤œà¥à¤·à¥‹à¤ƒ à¤°à¥à¤ƒ à¥®.à¥¨.à¥¬à¥¬ à¤‡à¤¤à¤¿ à¤°à¥à¤à¤¤à¥à¤µà¤®à¥ à¥¤ ]")
    print(f"â†’ à¤°à¤¾à¤®à¤°à¥   [ à¤‰à¤ªà¤¦à¥‡à¤¶à¥‡à¤½à¤œà¤¨à¥à¤¨à¤¾à¤¸à¤¿à¤• à¤‡à¤¤à¥... à¤‡à¤¤à¤¿ à¤‡à¤¤à¥-à¤²à¥‹à¤ªà¤ƒ à¥¤ ]")
    print(f"â†’ à¤°à¤¾à¤®à¤ƒ    [ à¤…à¤µà¤¸à¤¾à¤¨à¥‡ à¤ªà¤°à¥‡ à¤–à¤°à¤µà¤¸à¤¾à¤¨à¤¯à¥‹à¤°à¥à¤µà¤¿à¤¸à¤°à¥à¤œà¤¨à¥€à¤¯à¤ƒ à¥®.à¥©.à¥§à¥« à¤‡à¤¤à¤¿ à¤µà¤¿à¤¸à¤°à¥à¤—à¤ƒ à¥¤ ]")

    print("-" * 60)
    print(f"âœ… RESULT: {final_form}")

    assert final_form == "à¤°à¤¾à¤®à¤ƒ"

# ==============================================================================
# TEST 2: Prathama Dvivachana (1.2) -> RÄmau (à¤°à¤¾à¤®à¥Œ)
# ==============================================================================
def test_1_2_ramau():
    print("\n" + "="*60)
    print("ğŸš€ TEST 1.2: RÄma + Au (Prathama Dvivachana)")
    print("="*60)

    word = "à¤°à¤¾à¤®"
    vibhakti = 1
    vacana = 2
    logger = PrakriyaLogger()

    final_form = SubantaProcessor.derive_pada(word, vibhakti, vacana, logger)

    print(f"Input: {word}")
    print(f"â†’ {word} + à¤” [ à¥ª.à¥§.à¥¨ à¤‡à¤¤à¤¿ à¤”-à¤ªà¥à¤°à¤¤à¥à¤¯à¤¯à¤ƒ à¥¤ ]")
    print(f"â†’ (à¤ªà¥à¤°à¤¥à¤®à¤¯à¥‹à¤ƒ à¤ªà¥‚à¤°à¥à¤µà¤¸à¤µà¤°à¥à¤£à¤ƒ à¥¬.à¥§.à¥§à¥¦à¥¨ à¤‡à¤¤à¤¿ à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤à¥Œ... à¤¨à¤¾à¤¦à¤¿à¤šà¤¿ à¥¬.à¥§.à¥§à¥¦à¥ª à¤‡à¤¤à¤¿ à¤¨à¤¿à¤·à¥‡à¤§à¤ƒ) ")
    print(f"â†’ à¤°à¤¾à¤®à¥Œ [ à¤µà¥ƒà¤¦à¥à¤§à¤¿à¤°à¥‡à¤šà¤¿ à¥¬.à¥§.à¥®à¥® à¤‡à¤¤à¤¿ à¤ªà¥‚à¤°à¥à¤µà¤ªà¤°à¤¯à¥‹à¤ƒ à¤¸à¥à¤¥à¤¾à¤¨à¥‡ à¤µà¥ƒà¤¦à¥à¤§à¤¿-à¤à¤•à¤¾à¤¦à¥‡à¤¶à¤ƒ (à¤”) à¥¤ ]")

    print("-" * 60)
    print(f"âœ… RESULT: {final_form}")

    assert final_form == "à¤°à¤¾à¤®à¥Œ"

# ==============================================================================
# TEST 3: Prathama Bahuvachana (1.3) -> RÄmÄá¸¥ (à¤°à¤¾à¤®à¤¾à¤ƒ)
# ==============================================================================
def test_1_3_ramah_pl():
    print("\n" + "="*60)
    print("ğŸš€ TEST 1.3: RÄma + Jas (Prathama Bahuvachana)")
    print("="*60)

    word = "à¤°à¤¾à¤®"
    vibhakti = 1
    vacana = 3
    logger = PrakriyaLogger()

    final_form = SubantaProcessor.derive_pada(word, vibhakti, vacana, logger)

    print(f"Input: {word}")
    print(f"â†’ {word} + à¤œà¤¸à¥ [ à¥ª.à¥§.à¥¨ à¤‡à¤¤à¤¿ à¤œà¤¸à¥-à¤ªà¥à¤°à¤¤à¥à¤¯à¤¯à¤ƒ à¥¤ ]")
    print(f"â†’ {word} + à¤…à¤¸à¥ [ à¤šà¥à¤Ÿà¥‚ à¥§.à¥©.à¥­ à¤‡à¤¤à¤¿ à¤œà¤•à¤¾à¤°à¤¸à¥à¤¯ à¤‡à¤¤à¥à¤¸à¤‚à¤œà¥à¤à¤¾, à¤¤à¤¸à¥à¤¯ à¤²à¥‹à¤ªà¤ƒ à¥¤ ]")
    print(f"â†’ à¤°à¤¾à¤®à¤¾à¤¸à¥ [ à¤ªà¥à¤°à¤¥à¤®à¤¯à¥‹à¤ƒ à¤ªà¥‚à¤°à¥à¤µà¤¸à¤µà¤°à¥à¤£à¤ƒ à¥¬.à¥§.à¥§à¥¦à¥¨ à¤‡à¤¤à¤¿ à¤¦à¥€à¤°à¥à¤˜à¤ƒ (à¤†) à¥¤ ]")
    print(f"â†’ à¤°à¤¾à¤®à¤¾à¤ƒ [ à¤¸à¤¸à¤œà¥à¤·à¥‹à¤ƒ à¤°à¥à¤ƒ à¥®.à¥¨.à¥¬à¥¬, à¤–à¤°à¤µà¤¸à¤¾à¤¨à¤¯à¥‹à¤°à¥à¤µà¤¿à¤¸à¤°à¥à¤œà¤¨à¥€à¤¯à¤ƒ à¥®.à¥©.à¥§à¥« à¤‡à¤¤à¤¿ à¤µà¤¿à¤¸à¤°à¥à¤—à¤ƒ à¥¤ ]")

    print("-" * 60)
    print(f"âœ… RESULT: {final_form}")

    assert final_form == "à¤°à¤¾à¤®à¤¾à¤ƒ"

if __name__ == "__main__":
    test_1_1_ramah()
    test_1_2_ramau()
    test_1_3_ramah_pl()


================================================================================
FILE: tests/test_dvitiya.py
================================================================================

"""
FILE: tests/test_dvitiya.py
TEST CASE: Rama (Dvitiya Vibhakti) - Student Friendly Validation
"""
import unittest
from engine_main import PrakriyaLogger
from logic.subanta_processor import SubantaProcessor


class TestRamaDvitiya(unittest.TestCase):

    def setUp(self):
        self.logger = PrakriyaLogger()

    def test_2_1_ramam(self):
        """Test 2.1: RÄma + Am -> RÄmam"""
        print("\n" + "=" * 60)
        print("ğŸš€ TEST 2.1: RÄma + Am (Dvitiya Ekavachana)")
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 2, 1, self.logger)
        self.logger.print_history()  # Show Student Friendly Output

        self.assertEqual(res, "à¤°à¤¾à¤®à¤®à¥")
        print("âœ… Correct: à¤°à¤¾à¤®à¤®à¥")

    def test_2_2_ramau(self):
        """Test 2.2: RÄma + Aut -> RÄmau"""
        print("\n" + "=" * 60)
        print("ğŸš€ TEST 2.2: RÄma + Aut (Dvitiya Dvivachana)")
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 2, 2, self.logger)
        self.logger.print_history()

        self.assertEqual(res, "à¤°à¤¾à¤®à¥Œ")
        print("âœ… Correct: à¤°à¤¾à¤®à¥Œ")

    def test_2_3_raman(self):
        """Test 2.3: RÄma + Shas -> RÄmÄn"""
        print("\n" + "=" * 60)
        print("ğŸš€ TEST 2.3: RÄma + Shas (Dvitiya Bahuvachana)")
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 2, 3, self.logger)
        self.logger.print_history()

        self.assertEqual(res, "à¤°à¤¾à¤®à¤¾à¤¨à¥")
        print("âœ… Correct: à¤°à¤¾à¤®à¤¾à¤¨à¥")


if __name__ == '__main__':
    unittest.main()


================================================================================
FILE: tests/test_sambodhana.py
================================================================================

"""
FILE: tests/test_sambodhana.py
TEST CASE: Rama (Sambodhana - Vocative with 'Hey')
"""
import unittest
from engine_main import PrakriyaLogger
from logic.subanta_processor import SubantaProcessor

class TestRamaSambodhana(unittest.TestCase):
    def setUp(self): self.logger = PrakriyaLogger()

    def test_8_1_he_rama(self):
        """Test 8.1: RÄma + Su -> à¤¹à¥‡ à¤°à¤¾à¤®"""
        print("\n" + "="*60)
        print("ğŸš€ TEST 8.1: RÄma + Su (Sambodhana Ekavachana)")
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 8, 1, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤¹à¥‡ à¤°à¤¾à¤®")

    def test_8_2_he_ramau(self):
        """Test 8.2: RÄma + Au -> à¤¹à¥‡ à¤°à¤¾à¤®à¥Œ"""
        print("\n" + "="*60)
        print("ğŸš€ TEST 8.2: RÄma + Au (Sambodhana Dvivachana)")
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 8, 2, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤¹à¥‡ à¤°à¤¾à¤®à¥Œ")

    def test_8_3_he_ramah(self):
        """Test 8.3: RÄma + Jas -> à¤¹à¥‡ à¤°à¤¾à¤®à¤¾à¤ƒ"""
        print("\n" + "="*60)
        print("ğŸš€ TEST 8.3: RÄma + Jas (Sambodhana Bahuvachana)")
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 8, 3, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤¹à¥‡ à¤°à¤¾à¤®à¤¾à¤ƒ")

if __name__ == '__main__':
    unittest.main()



================================================================================
FILE: tests/test_tritiya.py
================================================================================

"""
FILE: tests/test_tritiya.py
TEST CASE: Rama (Tritiya Vibhakti)
"""
import unittest
from engine_main import PrakriyaLogger
from logic.subanta_processor import SubantaProcessor


class TestRamaTritiya(unittest.TestCase):

    def setUp(self):
        self.logger = PrakriyaLogger()

    def test_3_1_ramena(self):
        """Test 3.1: RÄma + TÄ -> RÄmeá¹‡a"""
        print("\n" + "=" * 60)
        print("ğŸš€ TEST 3.1: RÄma + TÄ (Tritiya Ekavachana)")
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 3, 1, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤°à¤¾à¤®à¥‡à¤£")

    def test_3_2_ramabhyam(self):
        """Test 3.2: RÄma + BhyÄm -> RÄmÄbhyÄm"""
        print("\n" + "=" * 60)
        print("ğŸš€ TEST 3.2: RÄma + BhyÄm (Tritiya Dvivachana)")
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 3, 2, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤°à¤¾à¤®à¤¾à¤­à¥à¤¯à¤¾à¤®à¥")

    def test_3_3_ramaih(self):
        """Test 3.3: RÄma + Bhis -> RÄmaiá¸¥"""
        print("\n" + "=" * 60)
        print("ğŸš€ TEST 3.3: RÄma + Bhis (Tritiya Bahuvachana)")
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 3, 3, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤°à¤¾à¤®à¥ˆà¤ƒ")


if __name__ == '__main__':
    unittest.main()


================================================================================
FILE: tests/__init__.py
================================================================================




================================================================================
FILE: tests/test_chaturthi.py
================================================================================

"""
FILE: tests/test_chaturthi.py
TEST CASE: Rama (Chaturthi Vibhakti)
"""
import unittest
from engine_main import PrakriyaLogger
from logic.subanta_processor import SubantaProcessor

class TestRamaChaturthi(unittest.TestCase):
    
    def setUp(self):
        self.logger = PrakriyaLogger()

    def test_4_1_ramaya(self):
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 4, 1, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤°à¤¾à¤®à¤¾à¤¯")

    def test_4_2_ramabhyam(self):
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 4, 2, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤°à¤¾à¤®à¤¾à¤­à¥à¤¯à¤¾à¤®à¥")

    def test_4_3_ramebhyah(self):
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 4, 3, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤°à¤¾à¤®à¥‡à¤­à¥à¤¯à¤ƒ")

if __name__ == '__main__':
    unittest.main()



================================================================================
FILE: tests/test_anga.py
================================================================================




================================================================================
FILE: tests/test_natva_examples.py
================================================================================

"""
FILE: tests/test_natva_examples.py
"""
import unittest
from core.core_foundation import Varna
from logic.sandhi_processor import SandhiProcessor
from core.core_foundation import ad, sanskrit_varna_samyoga

class TestNatvaStrict(unittest.TestCase):
    
    def check_natva(self, input_str, expected):
        # Helper to simulate 8.4.2 on a raw varna list
        varnas = ad(input_str)
        res_varnas = SandhiProcessor.run_tripadi(varnas)
        res_str = sanskrit_varna_samyoga(res_varnas)
        print(f"Input: {input_str} -> Output: {res_str} | Expected: {expected}")
        self.assertEqual(res_str, expected)

    def test_ex1_varini(self):
        # Vari + ni -> Varini (Vowel intervention)
        self.check_natva("à¤µà¤¾à¤°à¤¿à¤¨à¤¿", "à¤µà¤¾à¤°à¤¿à¤£à¤¿") # Mocking the state before Natva
        
    def test_ex2_drohena(self):
        # Droha + ena -> Drohena (H + Vowel intervention)
        self.check_natva("à¤¦à¥à¤°à¥‹à¤¹à¥‡à¤¨", "à¤¦à¥à¤°à¥‹à¤¹à¥‡à¤£")
        
    def test_ex3_brahmani(self):
        # Brahma + ani -> Brahmani (H + M + Vowel)
        self.check_natva("à¤¬à¥à¤°à¤¹à¥à¤®à¤¾à¤¨à¤¿", "à¤¬à¥à¤°à¤¹à¥à¤®à¤¾à¤£à¤¿")
        
    def test_ex5_murkhena(self):
        # Murkha + ena -> Murkhena (Ku + Vowel)
        self.check_natva("à¤®à¥‚à¤°à¥à¤–à¥‡à¤¨", "à¤®à¥‚à¤°à¥à¤–à¥‡à¤£")

if __name__ == '__main__':
    unittest.main()



================================================================================
FILE: tests/test_prathama.py
================================================================================

"""
FILE: tests/test_prathama.py
TEST CASE: Rama (Prathama Vibhakti)
"""
import unittest
import sys
import os

# Ensure imports work if run directly OR via master_runner
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from engine_main import PrakriyaLogger
from logic.subanta_processor import SubantaProcessor


class TestRamaPrathama(unittest.TestCase):

    def setUp(self):
        # This runs before EACH test function
        self.logger = PrakriyaLogger()

    def test_1_1_ramah(self):
        """Test 1.1: RÄma + Su -> RÄmaá¸¥"""
        # Run derivation
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 1, 1, self.logger)

        # Verify
        self.assertEqual(res, "à¤°à¤¾à¤®à¤ƒ", f"Expected à¤°à¤¾à¤®à¤ƒ but got {res}")

    def test_1_2_ramau(self):
        """Test 1.2: RÄma + Au -> RÄmau"""
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 1, 2, self.logger)
        self.assertEqual(res, "à¤°à¤¾à¤®à¥Œ", f"Expected à¤°à¤¾à¤®à¥Œ but got {res}")

    def test_1_3_ramah_plural(self):
        """Test 1.3: RÄma + Jas -> RÄmÄá¸¥"""
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 1, 3, self.logger)
        self.assertEqual(res, "à¤°à¤¾à¤®à¤¾à¤ƒ", f"Expected à¤°à¤¾à¤®à¤¾à¤ƒ but got {res}")


if __name__ == '__main__':
    unittest.main()


================================================================================
FILE: tests/ajnat_puling.py
================================================================================




================================================================================
FILE: tests/test_sandhi.py
================================================================================




================================================================================
FILE: tests/test_shashti.py
================================================================================

"""
FILE: tests/test_shashti.py
TEST CASE: Rama (Shashti Vibhakti - Genitive)
Goal: Verify 6.1 (Ramasya), 6.2 (Ramayoh), 6.3 (Ramanam)
"""
import unittest
from engine_main import PrakriyaLogger
from logic.subanta_processor import SubantaProcessor

class TestRamaShashti(unittest.TestCase):
    
    def setUp(self):
        self.logger = PrakriyaLogger()

    def test_6_1_ramasya(self):
        """Test 6.1: RÄma + Ngas -> RÄmasya"""
        print("\n" + "="*60)
        print("ğŸš€ TEST 6.1: RÄma + Ngas (Shashti Ekavachana)")
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 6, 1, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤°à¤¾à¤®à¤¸à¥à¤¯")

    def test_6_2_ramayoh(self):
        """Test 6.2: RÄma + Os -> RÄmayoá¸¥"""
        print("\n" + "="*60)
        print("ğŸš€ TEST 6.2: RÄma + Os (Shashti Dvivachana)")
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 6, 2, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤°à¤¾à¤®à¤¯à¥‹à¤ƒ")

    def test_6_3_ramanam(self):
        """Test 6.3: RÄma + Am -> RÄmÄá¹‡Äm"""
        print("\n" + "="*60)
        print("ğŸš€ TEST 6.3: RÄma + Am (Shashti Bahuvachana)")
        res = SubantaProcessor.derive_pada("à¤°à¤¾à¤®", 6, 3, self.logger)
        self.logger.print_history()
        self.assertEqual(res, "à¤°à¤¾à¤®à¤¾à¤£à¤¾à¤®à¥")

if __name__ == '__main__':
    unittest.main()



================================================================================
FILE: logic/anga_processor.py
================================================================================

"""
FILE: logic/anga_processor.py
PAS-v6.0 (Siddha) | PILLAR: Anga-Adhikara (6.4 - 7.4)
"""
from core.core_foundation import Varna, sanskrit_varna_samyoga

class AngaProcessor:
    @staticmethod
    def is_blocked_kniti(suffix, context=None):
        if not suffix: return False
        tags = getattr(suffix[0], 'sanjnas', set())
        if any(t in tags for t in ['kit', 'ngit', 'gnit']): return True
        return False

    @staticmethod
    def apply_guna_7_3_84(anga, suffix, context=None):
        if AngaProcessor.is_blocked_kniti(suffix): return anga, "Blocked by 1.1.5"
        if not anga: return anga, None
        last = anga[-1]
        guna_map = {'à¤‡': 'à¤', 'à¤ˆ': 'à¤', 'à¤‰': 'à¤“', 'à¤Š': 'à¤“', 'à¤‹': 'à¤…à¤°à¥', 'à¥ ': 'à¤…à¤°à¥', 'à¤Œ': 'à¤…à¤²à¥'}
        if last.char in guna_map:
            res = guna_map[last.char]
            if len(res) > 1 and res != 'à¤“' and res != 'à¤':
                anga.pop()
                for c in res:
                    v = Varna(c); v.trace.append("7.3.84")
                    anga.append(v)
            else:
                last.char = res; last.trace.append("7.3.84")
            return anga, "7.3.84"
        return anga, None

    @staticmethod
    def apply_puganta_laghupadhasya_7_3_86(anga, suffix):
        if AngaProcessor.is_blocked_kniti(suffix): return anga, "Blocked by 1.1.5"
        if len(anga) < 2: return anga, None
        upadha = anga[-2]
        guna_map = {'à¤‡': 'à¤', 'à¤‰': 'à¤“', 'à¤‹': 'à¤…à¤°à¥', 'à¤Œ': 'à¤…à¤²à¥'}
        if upadha.char in guna_map:
            upadha.char = guna_map[upadha.char]; upadha.trace.append("7.3.86")
            return anga, "7.3.86"
        return anga, None

    @staticmethod
    def apply_mrjer_vriddhih_7_2_114(anga, suffix):
        if AngaProcessor.is_blocked_kniti(suffix): return anga, "Blocked"
        applied = False
        for v in anga:
            if v.char == 'à¤‹':
                v.char = 'à¤†'; v.trace.append("7.2.114"); applied = True
        return anga, "7.2.114" if applied else None

    @staticmethod
    def apply_aco_niti_7_2_115(anga, suffix):
        if not suffix: return anga, None
        tags = getattr(suffix[0], 'sanjnas', set())
        if not ({'nit', 'á¹‡it'} & tags): return anga, None
        last = anga[-1]
        vriddhi_map = {'à¤…': 'à¤†', 'à¤‡': 'à¤', 'à¤ˆ': 'à¤', 'à¤‰': 'à¤”', 'à¤Š': 'à¤”', 'à¤‹': 'à¤†à¤°à¥', 'à¤': 'à¤', 'à¤“': 'à¤”'}
        if last.char in vriddhi_map:
            res = vriddhi_map[last.char]
            if len(res) > 1 and res != 'à¤”' and res != 'à¤':
                anga.pop()
                for c in res:
                    v = Varna(c); v.trace.append("7.2.115")
                    anga.append(v)
            else:
                last.char = res; last.trace.append("7.2.115")
            return anga, "7.2.115"
        return anga, None


================================================================================
FILE: logic/krt_processor.py
================================================================================




================================================================================
FILE: logic/__init__.py
================================================================================

# panini_engine/logic/__init__.py
from .anga_processor import AngaProcessor
from .sandhi_processor import SandhiProcessor


================================================================================
FILE: logic/sandhi_processor.py
================================================================================

"""
FILE: logic/sandhi_processor.py
"""
from core.core_foundation import Varna, sanskrit_varna_samyoga

class SandhiProcessor:
    @staticmethod
    def apply_ac_sandhi(anga, suffix):
        if not anga or not suffix: return anga + suffix, None
        last = anga[-1]; first = suffix[0]

        # R6: Ayadi (6.1.78)
        if first.is_vowel:
            if last.char == 'à¤':
                last.char = 'à¤…'; y_v = Varna('à¤¯à¥'); y_v.trace.append("6.1.78")
                anga.append(y_v); return anga + suffix, "6.1.78 (à¤à¤šà¥‹à¤½à¤¯à¤µà¤¾à¤¯à¤¾à¤µà¤ƒ)"
            elif last.char == 'à¤“':
                last.char = 'à¤…'; v_v = Varna('à¤µà¥'); v_v.trace.append("6.1.78")
                anga.append(v_v); return anga + suffix, "6.1.78 (à¤à¤šà¥‹à¤½à¤¯à¤µà¤¾à¤¯à¤¾à¤µà¤ƒ)"

        # Guna (6.1.87)
        if last.char in ['à¤…', 'à¤†'] and first.char in ['à¤‡', 'à¤ˆ']:
            last.char = 'à¤'; suffix.pop(0); return anga + suffix, "6.1.87 (à¤†à¤¦à¥à¤—à¥à¤£à¤ƒ)"

        # Savarna Dirgha (6.1.101)
        if last.char in ['à¤…', 'à¤†'] and first.char in ['à¤…', 'à¤†']:
            last.char = 'à¤†'; suffix.pop(0); return anga + suffix, "6.1.101 (à¤…à¤•à¤ƒ à¤¸à¤µà¤°à¥à¤£à¥‡ à¤¦à¥€à¤°à¥à¤˜à¤ƒ)"

        # Vriddhi (6.1.88)
        if last.char in ['à¤…', 'à¤†'] and first.char in ['à¤', 'à¤', 'à¤“', 'à¤”']:
            last.char = 'à¤' if first.char in ['à¤', 'à¤'] else 'à¤”'
            suffix.pop(0); return anga + suffix, "6.1.88 (à¤µà¥ƒà¤¦à¥à¤§à¤¿à¤°à¥‡à¤šà¤¿)"

        return anga + suffix, None

    @staticmethod
    def run_tripadi(v_list, logger=None):
        if not v_list: return []
        
        # R7: Shattva (8.3.59)
        for i in range(1, len(v_list)):
            if v_list[i].char == 'à¤¸à¥':
                prev = v_list[i-1].char
                if any(v in prev for v in "à¤‡à¤ˆà¤‰à¤Šà¤‹à¥ à¤à¤à¤“à¤”") or prev in ['à¤¯à¥','à¤µà¥','à¤°à¥','à¤²à¥','à¤¹à¥', 'à¤•à¥','à¤–à¥','à¤—à¥','à¤˜à¥','à¤™à¥']:
                    v_list[i].char = 'à¤·à¥'; v_list[i].trace.append("8.3.59")
                    if logger: logger.log("8.3.59 (à¤†à¤¦à¥‡à¤¶à¤ªà¥à¤°à¤¤à¥à¤¯à¤¯à¤¯à¥‹à¤ƒ)", "Shattva (à¤·à¤¤à¥à¤µ)", sanskrit_varna_samyoga(v_list), v_list)

        # R17: Natva (8.4.2)
        triggers = [i for i, v in enumerate(v_list) if v.char in ['à¤°à¥', 'à¤·à¥', 'à¤‹', 'à¥ ']]
        targets = [i for i, v in enumerate(v_list) if v.char == 'à¤¨à¥']
        for t_idx in targets:
            valid_trigs = [tr for tr in triggers if tr < t_idx]
            if valid_trigs:
                blocked = False
                for j in range(valid_trigs[-1] + 1, t_idx):
                    c = v_list[j].char
                    if not (any(v in c for v in "à¤…à¤†à¤‡à¤ˆà¤‰à¤Šà¤‹à¥ à¤à¤à¤“à¤”à¤‚") or c in "à¤¹à¥ à¤¯à¥ à¤µà¥ à¤°à¥ à¤•à¥ à¤–à¥ à¤—à¥ à¤˜à¥ à¤™à¥ à¤ªà¥ à¤«à¥ à¤¬à¥ à¤­à¥ à¤®à¥".split()):
                        blocked = True; break
                if not blocked: 
                    v_list[t_idx].char = 'à¤£à¥'; v_list[t_idx].trace.append("8.4.2")
                    if logger: logger.log("8.4.2 (à¤…à¤Ÿà¥à¤•à¥à¤ªà¥à¤µà¤¾à¤™à¥...)", "Natva (à¤£à¤¤à¥à¤µ)", sanskrit_varna_samyoga(v_list), v_list)

        # R9: Visarga Logic (Rutva -> Visarga)
        if v_list[-1].char in ['à¤¸à¥', 'à¤·à¥']:
            # 1. Sasajusho Ruh (8.2.66)
            v_list[-1].char = 'à¤°à¥' 
            if logger: logger.log("8.2.66 (à¤¸à¤¸à¤œà¥à¤·à¥‹à¤ƒ à¤°à¥à¤ƒ)", "Rutva (à¤°à¥à¤à¤¤à¥à¤µà¤®à¥)", sanskrit_varna_samyoga(v_list), v_list)
            
            # 2. Kharavasanayor Visarjaniyah (8.3.15)
            v_list[-1].char = 'à¤ƒ'
            if logger: logger.log("8.3.15 (à¤–à¤°à¤µà¤¸à¤¾à¤¨à¤¯à¥‹à¤°à¥à¤µà¤¿à¤¸à¤°à¥à¤œà¤¨à¥€à¤¯à¤ƒ)", "Visarga (à¤µà¤¿à¤¸à¤°à¥à¤—à¤ƒ)", sanskrit_varna_samyoga(v_list), v_list)
        
        # Check if already R (e.g. Punar)
        elif v_list[-1].char == 'à¤°à¥':
             v_list[-1].char = 'à¤ƒ'
             if logger: logger.log("8.3.15 (à¤–à¤°à¤µà¤¸à¤¾à¤¨à¤¯à¥‹à¤°à¥à¤µà¤¿à¤¸à¤°à¥à¤œà¤¨à¥€à¤¯à¤ƒ)", "Visarga (à¤µà¤¿à¤¸à¤°à¥à¤—à¤ƒ)", sanskrit_varna_samyoga(v_list), v_list)
             
        return v_list



================================================================================
FILE: logic/tinanta_processor.py
================================================================================




================================================================================
FILE: logic/subanta_processor.py
================================================================================

"""
FILE: logic/subanta_processor.py
"""
from core.core_foundation import Varna, ad, sanskrit_varna_samyoga, UpadeshaType
from core.sanjna_controller import SanjnaController
from core.knowledge_base import KnowledgeBase
from logic.sandhi_processor import SandhiProcessor

class SubantaProcessor:
    @staticmethod
    def derive_pada(stem_str, vibhakti, vacana, logger=None):
        stem = ad(stem_str); is_at = (stem[-1].char == 'à¤…')
        sup_data = KnowledgeBase.get_sup(vibhakti, vacana)
        if not sup_data: return "?"
        raw_sup, tags = sup_data; suffix = ad(raw_sup)
        
        # 1. Suffix Attachment (à¤ªà¥à¤°à¤¤à¥à¤¯à¤¯ à¤‰à¤¤à¥à¤ªà¤¤à¥à¤¤à¤¿)
        if logger: logger.log("4.1.2", f"Suffix Attachment ({raw_sup})", f"{stem_str} + {raw_sup}", stem + suffix)
        
        # 2. It-Prakaran (à¤‡à¤¤à¥ à¤¸à¤‚à¤œà¥à¤à¤¾ à¤”à¤° à¤²à¥‹à¤ª)
        clean_suffix, trace = SanjnaController.run_it_prakaran(suffix, UpadeshaType.VIBHAKTI)
        if clean_suffix: clean_suffix[0].sanjnas.update(tags)
        
        # Log It-Lopa steps
        if logger and trace:
             logger.log(f"{trace[-1]}", "It-Lopa (à¤‡à¤¤à¥ à¤¸à¤‚à¤œà¥à¤à¤¾ à¤²à¥‹à¤ª)", sanskrit_varna_samyoga(stem + clean_suffix), stem + clean_suffix)

        # [8.1] Sambodhana - Su Lopa (6.1.69)
        if vibhakti == 8 and vacana == 1 and is_at:
            if clean_suffix and clean_suffix[0].char == 'à¤¸à¥':
                clean_suffix = [] 
                if logger: logger.log("6.1.69 (à¤à¤™à¥à¤¹à¥à¤°à¤¸à¥à¤µà¤¾à¤¤à¥ à¤¸à¤®à¥à¤¬à¥à¤¦à¥à¤§à¥‡à¤ƒ)", "Sambuddhi Lopa (à¤¸à¤®à¥à¤¬à¥à¤¦à¥à¤§à¤¿à¤²à¥‹à¤ªà¤¾)", sanskrit_varna_samyoga(stem), stem)

        # R11: Niyama - Special Substitutions
        if is_at:
            if vibhakti == 3 and vacana == 1: 
                clean_suffix = ad("à¤‡à¤¨")
                if logger: logger.log("7.1.12", "Ta -> Ina (à¤Ÿà¤¾à¤™à¤¸à¤¿à¤™...)", "à¤°à¤¾à¤®à¥‡à¤¨", stem + clean_suffix)
            elif vibhakti == 3 and vacana == 3: 
                clean_suffix = ad("à¤à¤¸à¥")
                if logger: logger.log("7.1.9", "Bhis -> Ais (à¤…à¤¤à¥‹ à¤­à¤¿à¤¸ à¤à¤¸à¥)", "à¤°à¤¾à¤®à¤à¤¸à¥", stem + clean_suffix)
            elif vibhakti == 4 and vacana == 1: 
                clean_suffix = ad("à¤¯")
                if logger: logger.log("7.1.13", "Ne -> Ya (à¤™à¥‡à¤°à¥à¤¯à¤ƒ)", "à¤°à¤¾à¤®à¤¯", stem + clean_suffix)
            elif vibhakti == 5 and vacana == 1: 
                clean_suffix = ad("à¤†à¤¤à¥")
                if logger: logger.log("7.1.12", "Ngasi -> At (à¤Ÿà¤¾à¤™à¤¸à¤¿à¤™...)", "à¤°à¤¾à¤®à¤†à¤¤à¥", stem + clean_suffix)
            elif vibhakti == 6 and vacana == 1: 
                clean_suffix = ad("à¤¸à¥à¤¯")
                if logger: logger.log("7.1.12", "Ngas -> Sya (à¤Ÿà¤¾à¤™à¤¸à¤¿à¤™...)", "à¤°à¤¾à¤®à¤¸à¥à¤¯", stem + clean_suffix)
            elif vibhakti == 6 and vacana == 3: 
                clean_suffix = ad("à¤¨à¥") + clean_suffix
                if logger: logger.log("7.1.54", "Nut Agama (à¤¹à¥à¤°à¤¸à¥à¤µà¤¨à¤¦à¥à¤¯à¤¾à¤ªà¥‹ à¤¨à¥à¤Ÿà¥)", "à¤°à¤¾à¤®à¤¨à¤¾à¤®à¥", stem + clean_suffix)
                stem[-1].char = 'à¤†' # Nami
                if logger: logger.log("6.4.3", "Nami (Dirgha) (à¤¨à¤¾à¤®à¤¿)", "à¤°à¤¾à¤®à¤¾à¤¨à¤¾à¤®à¥", stem + clean_suffix)

        # R12: Adhikara - Mutators
        if is_at and clean_suffix:
            f = clean_suffix[0].char
            # Jhalyet
            if vacana == 3 and f in ['à¤­à¥', 'à¤¸à¥']: 
                if not (vibhakti == 2 and vacana == 3): 
                    stem[-1].char = 'à¤'
                    if logger: logger.log("7.3.103", "Bahuvacane Jhalyet (à¤¬à¤¹à¥à¤µà¤šà¤¨à¥‡ à¤à¤²à¥à¤¯à¥‡à¤¤à¥)", sanskrit_varna_samyoga(stem + clean_suffix), stem + clean_suffix)
            # Osi Ca
            elif vibhakti in [6, 7] and vacana == 2: 
                stem[-1].char = 'à¤'
                if logger: logger.log("7.3.104", "Osi Ca (à¤“à¤¸à¤¿ à¤š)", sanskrit_varna_samyoga(stem + clean_suffix), stem + clean_suffix)
            # Supi Ca
            elif f in ['à¤­à¥', 'à¤¯', 'à¤µà¥', 'à¤¯à¥', 'à¤µ']: 
                stem[-1].char = 'à¤†'
                if logger: logger.log("7.3.102", "Supi Ca (à¤¸à¥à¤ªà¤¿ à¤š)", sanskrit_varna_samyoga(stem + clean_suffix), stem + clean_suffix)

        # 2.1 Ami Purvah Bypass
        if is_at and vibhakti == 2 and vacana == 1:
            res_str = stem_str + "à¤®à¥"
            if logger: logger.log("6.1.107", "Ami Purvah (à¤…à¤®à¤¿ à¤ªà¥‚à¤°à¥à¤µà¤ƒ)", res_str, ad(res_str))
            return res_str

        # Sandhi
        fp, rule = SandhiProcessor.apply_ac_sandhi(stem, clean_suffix)
        if logger and rule:
             logger.log(rule, "Sandhi", sanskrit_varna_samyoga(fp), fp)
        
        # 2.3 Shaso Nah Pumsi
        if is_at and vibhakti == 2 and vacana == 3:
            if fp[-1].char == 'à¤¸à¥' or fp[-1].char == 'à¤ƒ':
                fp[-1].char = 'à¤¨à¥'
                if logger: logger.log("6.1.103", "Shaso Nah (à¤¤à¤¸à¥à¤®à¤¾à¤šà¥à¤›à¤¸à¥‹ à¤¨à¤ƒ à¤ªà¥à¤‚à¤¸à¤¿)", sanskrit_varna_samyoga(fp), fp)
                return sanskrit_varna_samyoga(fp)

        # Tripadi (Visarga etc.)
        final = SandhiProcessor.run_tripadi(fp, logger) # Sending Logger to Tripadi
        res = sanskrit_varna_samyoga(final)
        
        # [USER REQUEST]: Add 'He' prefix for Case 8 output
        if vibhakti == 8:
            return "à¤¹à¥‡ " + res

        return res



================================================================================
FILE: pages/1_ğŸ”_Declension_Engine.py
================================================================================

import streamlit as st
import pandas as pd
from engine_main import PrakriyaLogger
from logic.subanta_processor import SubantaProcessor

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Page Configuration
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="à¤¶à¤¬à¥à¤¦-à¤°à¥‚à¤ª à¤¸à¤¿à¤¦à¥à¤§à¤¿ à¤¯à¤¨à¥à¤¤à¥à¤°",
    page_icon="ğŸ•‰ï¸",
    layout="wide",
    initial_sidebar_state="expanded"
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Modern + Elegant CSS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;700&family=Poppins:wght@400;500;600;700&display=swap');

    :root {
        --primary: #6d28d9;
        --primary-dark: #5b21b6;
        --accent: #a78bfa;
        --text: #1e293b;
        --text-light: #64748b;
        --bg-card: #ffffff;
        --bg-light: #f8fafc;
    }

    html, body, [data-testid="stAppViewContainer"] {
        font-family: 'Poppins', 'Noto Sans Devanagari', sans-serif !important;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    .stAppHeader, header {
        background: transparent !important;
    }

    h1, h2, h3 {
        color: var(--text);
        font-weight: 700;
        letter-spacing: -0.5px;
    }

    h1 {
        font-size: 2.8rem !important;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.4rem;
    }

    .subtitle {
        color: var(--text-light);
        font-size: 1.15rem;
        margin-bottom: 2rem;
    }

    /* Modern Card */
    .card {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 1.8rem 2rem;
        box-shadow: 0 10px 30px -10px rgba(0,0,0,0.08);
        border: 1px solid rgba(109,40,217,0.08);
        margin: 1.5rem 0;
        transition: all 0.28s ease;
    }
    .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px -15px rgba(109,40,217,0.15);
    }

    .section-title {
        font-size: 1.35rem;
        font-weight: 600;
        color: var(--primary);
        margin: 1.8rem 0 1rem;
        padding-bottom: 0.6rem;
        border-bottom: 3px solid var(--accent);
        display: inline-block;
    }

    /* Input area */
    .stTextInput > div > div > input {
        border-radius: 12px;
        border: 2px solid #e2e8f0;
        padding: 14px 16px !important;
        font-size: 1.05rem;
    }
    .stTextInput > div > div > input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(109,40,217,0.15);
    }

    /* Buttons */
    .stButton > button {
        background: linear-gradient(90deg, var(--primary), var(--primary-dark));
        color: white !important;
        border: none;
        border-radius: 12px;
        padding: 0.75rem 2rem !important;
        font-weight: 600;
        font-size: 1.05rem;
        transition: all 0.25s;
    }
    .stButton > button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 20px rgba(109,40,217,0.3);
    }

    /* Sanskrit strong emphasis */
    .sanskrit {
        font-family: 'Noto Sans Devanagari', serif;
        font-weight: 700;
        color: #1e293b;
        font-size: 1.45rem;
        letter-spacing: 0.5px;
    }

    /* Viccheda tiles */
    .viccheda-container {
        background: #f1f5f9;
        border-radius: 12px;
        padding: 1.2rem;
        margin: 1rem 0;
        display: flex;
        flex-wrap: wrap;
        gap: 0.7rem;
        align-items: center;
    }
    .varna-tile {
        background: white;
        border: 1px solid #cbd5e1;
        color: #c2410c;
        padding: 0.55rem 1rem;
        border-radius: 10px;
        font-family: 'Noto Sans Devanagari', monospace;
        font-size: 1.25rem;
        font-weight: 500;
        box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }
    .plus-sign {
        color: #94a3b8;
        font-weight: bold;
        font-size: 1.4rem;
        margin: 0 0.2rem;
    }

    /* Badge */
    .badge {
        background: linear-gradient(90deg, var(--primary), var(--accent));
        color: white;
        padding: 0.35rem 1rem;
        border-radius: 2rem;
        font-size: 0.9rem;
        font-weight: 600;
        display: inline-block;
        margin-bottom: 0.8rem;
    }

    hr {
        margin: 2.2rem 0;
        border-color: #e2e8f0;
    }
    </style>
""", unsafe_allow_html=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Constants
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
VIBHAKTI_MAP = {
    1: "à¤ªà¥à¤°à¤¥à¤®à¤¾", 2: "à¤¦à¥à¤µà¤¿à¤¤à¥€à¤¯à¤¾", 3: "à¤¤à¥ƒà¤¤à¥€à¤¯à¤¾", 4: "à¤šà¤¤à¥à¤°à¥à¤¥à¥€",
    5: "à¤ªà¤à¥à¤šà¤®à¥€", 6: "à¤·à¤·à¥à¤ à¥€", 7: "à¤¸à¤ªà¥à¤¤à¤®à¥€", 8: "à¤¸à¤®à¥à¤¬à¥‹à¤§à¤¨"
}
VACANA_MAP = {1: "à¤à¤•à¤µà¤šà¤¨à¤®à¥", 2: "à¤¦à¥à¤µà¤¿à¤µà¤šà¤¨à¤®à¥", 3: "à¤¬à¤¹à¥à¤µà¤šà¤¨à¤®à¥"}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  UI
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("<h1>ğŸ•‰ï¸ à¤¶à¤¬à¥à¤¦-à¤°à¥‚à¤ª à¤¸à¤¿à¤¦à¥à¤§à¤¿ à¤¯à¤¨à¥à¤¤à¥à¤°</h1>", unsafe_allow_html=True)
st.markdown('<div class="subtitle">à¤ªà¤¾à¤£à¤¿à¤¨à¥€à¤¯ à¤µà¥à¤¯à¤¾à¤•à¤°à¤£ à¤•à¥€ à¤ªà¥à¤°à¤•à¥à¤°à¤¿à¤¯à¤¾ à¤•à¥‹ à¤ªà¤¾à¤°à¤¦à¤°à¥à¤¶à¥€ à¤°à¥‚à¤ª à¤¸à¥‡ à¤¸à¤®à¤à¥‡à¤‚</div>', unsafe_allow_html=True)

# â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.header("à¤ªà¥à¤°à¤¾à¤¤à¤¿à¤ªà¤¦à¤¿à¤• à¤‡à¤¨à¤ªà¥à¤Ÿ")
    stem = st.text_input("à¤ªà¥à¤°à¤¾à¤¤à¤¿à¤ªà¤¦à¤¿à¤•", value="à¤°à¤¾à¤®", help="à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤®à¥‡à¤‚ à¤…à¤•à¤¾à¤°à¤¾à¤¨à¥à¤¤ à¤ªà¥à¤²à¥à¤²à¤¿à¤™à¥à¤— à¤¶à¤¬à¥à¤¦à¥‹à¤‚ à¤•à¥‡ à¤²à¤¿à¤ à¤…à¤¨à¥à¤•à¥‚à¤²à¤¿à¤¤")

    st.info("âš¡ à¤…à¤•à¤¾à¤°à¤¾à¤¨à¥à¤¤ à¤ªà¥à¤²à¥à¤²à¤¿à¤‚à¤— à¤¶à¤¬à¥à¤¦ (à¤°à¤¾à¤®, à¤¦à¥‡à¤µ, à¤¹à¤°à¤¿ à¤†à¤¦à¤¿)")

# â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if stem.strip():
    # Full Table (beautiful expander)
    with st.expander("ğŸ“Š à¤ªà¥‚à¤°à¥à¤£ à¤¶à¤¬à¥à¤¦-à¤°à¥‚à¤ª à¤¤à¤¾à¤²à¤¿à¤•à¤¾", expanded=True):
        table_data = []
        for v in range(1, 9):
            row = {"à¤µà¤¿à¤­à¤•à¥à¤¤à¤¿": VIBHAKTI_MAP[v]}
            for n in range(1, 4):
                word = SubantaProcessor.derive_pada(stem, v, n, None)
                row[VACANA_MAP[n]] = word
            table_data.append(row)

        df = pd.DataFrame(table_data)

        st.dataframe(
            df,
            use_container_width=True,
            hide_index=True,
            column_config={
                "à¤µà¤¿à¤­à¤•à¥à¤¤à¤¿": st.column_config.TextColumn("à¤µà¤¿à¤­à¤•à¥à¤¤à¤¿", width="medium"),
                "à¤à¤•à¤µà¤šà¤¨à¤®à¥": st.column_config.TextColumn("à¤à¤•à¤µà¤šà¤¨à¤®à¥", width="large"),
                "à¤¦à¥à¤µà¤¿à¤µà¤šà¤¨à¤®à¥": st.column_config.TextColumn("à¤¦à¥à¤µà¤¿à¤µà¤šà¤¨à¤®à¥", width="large"),
                "à¤¬à¤¹à¥à¤µà¤šà¤¨à¤®à¥": st.column_config.TextColumn("à¤¬à¤¹à¥à¤µà¤šà¤¨à¤®à¥", width="large"),
            }
        )

    # â”€â”€ Process Inspector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    st.markdown('<div class="section-title">ğŸ”¬ à¤¸à¤¿à¤¦à¥à¤§à¤¿ à¤ªà¥à¤°à¤•à¥à¤°à¤¿à¤¯à¤¾ (Step-by-Step)</div>', unsafe_allow_html=True)

    col1, col2, _ = st.columns([2, 2, 3])
    with col1:
        sel_vib = st.selectbox("à¤µà¤¿à¤­à¤•à¥à¤¤à¤¿", options=list(VIBHAKTI_MAP.keys()),
                               format_func=lambda x: VIBHAKTI_MAP[x],
                               index=0)
    with col2:
        sel_vac = st.selectbox("à¤µà¤šà¤¨", options=list(VACANA_MAP.keys()),
                               format_func=lambda x: VACANA_MAP[x],
                               index=0)

    if st.button("ğŸš€ à¤¸à¤¿à¤¦à¥à¤§ à¤ªà¤¦ & à¤ªà¥à¤°à¤•à¥à¤°à¤¿à¤¯à¤¾ à¤¦à¥‡à¤–à¥‡à¤‚", type="primary", use_container_width=True):
        with st.spinner("à¤ªà¤¾à¤£à¤¿à¤¨à¤¿ à¤¸à¥‚à¤¤à¥à¤° à¤šà¤² à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚..."):
            logger = PrakriyaLogger()
            final_res = SubantaProcessor.derive_pada(stem, sel_vib, sel_vac, logger)

            st.success(f"**à¤¸à¤¿à¤¦à¥à¤§ à¤ªà¤¦ â†’**  <span class='sanskrit'>{final_res}</span>", unsafe_allow_html=True)

            history = logger.get_history()

            if not history:
                st.info("à¤•à¥‹à¤ˆ à¤ªà¥à¤°à¤•à¥à¤°à¤¿à¤¯à¤¾ à¤šà¤°à¤£ à¤‰à¤ªà¤²à¤¬à¥à¤§ à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆà¥¤")
            else:
                for i, step in enumerate(history, 1):
                    with st.container():
                        st.markdown(f"""
                        <div class="card">
                            <div class="badge">à¤šà¤°à¤£ {i}  â€¢  à¤¸à¥‚à¤¤à¥à¤°: {step['rule']}</div>
                            <div style="font-size:1.15rem; font-weight:600; margin:0.8rem 0;">
                                {step['operation']}
                            </div>
                        """, unsafe_allow_html=True)

                        # Improved viccheda tiles
                        if step.get('viccheda'):
                            parts = step['viccheda'].split(' + ')
                            tiles = ''.join([
                                f'<span class="varna-tile">{p}</span>'
                                if j == len(parts) - 1 else
                                f'<span class="varna-tile">{p}</span><span class="plus-sign">+</span>'
                                for j, p in enumerate(parts)
                            ])
                            st.markdown(f"""
                                <div class="viccheda-container">
                                    {tiles}
                                </div>
                            """, unsafe_allow_html=True)

                        st.markdown(f"""
                            <div style="margin-top:1.2rem; padding-top:1rem; border-top:1px dashed #e2e8f0;">
                                <strong style="color:var(--text-light);">à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤…à¤µà¤¸à¥à¤¥à¤¾ â†’ </strong>
                                <span class="sanskrit">{step['result']}</span>
                            </div>
                            </div>
                        """, unsafe_allow_html=True)

else:
    st.warning("à¤•à¥ƒà¤ªà¤¯à¤¾ à¤ªà¥à¤°à¤¾à¤¤à¤¿à¤ªà¤¦à¤¿à¤• à¤ªà¥à¤°à¤µà¤¿à¤·à¥à¤Ÿ à¤•à¤°à¥‡à¤‚ (à¤‰à¤¦à¤¾. à¤°à¤¾à¤®, à¤¦à¥‡à¤µ, à¤—à¥à¤°à¥â€¦)")

st.markdown("<br><br>", unsafe_allow_html=True)


